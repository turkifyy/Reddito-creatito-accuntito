name: ๐ Reddit Automation System V2 - Production

# โญ ููุงุญุธุฉ ูุงูุฉ: 
# ูุฐุง ุงูู workflow ูููู ุจุฅูุดุงุก package-lock.json ุชููุงุฆูุงู ูู ูู ุชุดุบูู
# ุฅุฐุง ุฃุฑุฏุช ุชูุนูู ุงูู cache ูุชุณุฑูุน ุงูุชุซุจูุชุ ุงุชุจุน ุงูุฎุทูุงุช ุงูุชุงููุฉ:
# 1. ูู ุจุชุดุบูู: npm install --package-lock-only --legacy-peer-deps
# 2. ูู ุจุฅุถุงูุฉ package-lock.json ุฅูู ุงูู repository: git add package-lock.json
# 3. ูู ุจุนูู commit: git commit -m "๐ฆ ุฅุถุงูุฉ package-lock.json"
# 4. ูู ุจุชูุนูู cache: 'npm' ูู ุฎุทูุงุช setup-node

on:
  # ุงูุชุดุบูู ุงูุชููุงุฆู ุนูุฏ push ุฅูู branch main
  push:
    branches: [ main, master ]
  
  # ุงูุชุดุบูู ุงููุฏูู ูู ูุงุฌูุฉ GitHub Actions
  workflow_dispatch:
    inputs:
      run_mode:
        description: 'ูุถุน ุงูุชุดุบูู'
        required: true
        default: 'normal'
        type: choice
        options:
        - normal
        - recovery
        - test
      target_accounts:
        description: 'ุนุฏุฏ ุงูุญุณุงุจุงุช ุงููุณุชูุฏู'
        required: false
        type: number
        default: 48
      max_runtime:
        description: 'ุงูุญุฏ ุงูุฃูุตู ููุชุดุบูู (ุฏูุงุฆู)'
        required: false
        type: number
        default: 360

# โญ ุงูุฅุตูุงุญ: ุฅุถุงูุฉ ุงูุตูุงุญูุงุช ุงููุงุฒูุฉ ููู workflow
permissions:
  contents: read
  issues: write
  actions: write

env:
  NODE_VERSION: '20.x'  # โญ ุงูุฅุตูุงุญ: ุชุญุฏูุซ ุฅูู Node 20 ูุญู ูุดููุฉ undici
  CHROME_VERSION: '120'
  TIMEZONE: 'Asia/Riyadh'

jobs:
  # ๐ ูุญุต ุงูุฌุงูุฒูุฉ ูุงููุธุงู
  system-check:
    name: ๐ ูุญุต ุฌุงูุฒูุฉ ุงููุธุงู V2
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    outputs:
      health-status: ${{ steps.health-check.outputs.status }}
      sheets-connected: ${{ steps.sheets-check.outputs.connected }}
      email-service: ${{ steps.email-check.outputs.status }}
      ready: ${{ steps.final-check.outputs.ready }}

    steps:
    - name: ๐ฅ ุงูุญุตูู ุนูู ุงูููุฏ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ๐๏ธ ุฅุนุฏุงุฏ Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        # โญ ุงูุฅุตูุงุญ: ุฅุฒุงูุฉ cache ูุฃู package-lock.json ุบูุฑ ููุฌูุฏ ุญุงููุงู
        # cache: 'npm'

    # โญ ุงูุฅุตูุงุญ: ุฅุถุงูุฉ ุฎุทูุฉ ูุชุญุฏูุซ package-lock.json
    - name: ๐ ุฅูุดุงุก package-lock.json
      run: |
        echo "๐ ุฅูุดุงุก package-lock.json..."
        if [ ! -f "package-lock.json" ]; then
          echo "โ๏ธ package-lock.json ุบูุฑ ููุฌูุฏ - ุณูุชู ุฅูุดุงุคู"
          npm install --package-lock-only --legacy-peer-deps
          echo "โ ุชู ุฅูุดุงุก package-lock.json"
        else
          echo "โ package-lock.json ููุฌูุฏ - ุณูุชู ุงูุชุญูู ูู ุงูุชุฒุงูู"
          npm install --package-lock-only --legacy-peer-deps
          echo "โ ุชู ุชุญุฏูุซ package-lock.json"
        fi
        
        # ุนุฑุถ ูุนูููุงุช ุงูููู
        if [ -f "package-lock.json" ]; then
          echo "๐ ูุนูููุงุช package-lock.json:"
          ls -lh package-lock.json
        fi

    - name: ๐ฆ ุชุซุจูุช ุงูุงุนุชูุงุฏูุงุช ุงูุฃุณุงุณูุฉ
      run: |
        echo "๐ฆ ุจุฏุก ุชุซุจูุช ุงูุงุนุชูุงุฏูุงุช..."
        # ุงุณุชุฎุฏุงู npm install ุจุฏูุงู ูู npm ci ููุชุนุงูู ูุน ุนุฏู ุงูุชุฒุงูู
        npm install --legacy-peer-deps
        echo "โ ุชู ุชุซุจูุช ุงูุงุนุชูุงุฏูุงุช ุงูุฃุณุงุณูุฉ"
        echo "๐ ูุงุฆูุฉ ุงูุญุฒู ุงููุซุจุชุฉ:"
        npm list --depth=0 || true

    # โญ ุงุฎุชูุงุฑู: ุญูุธ package-lock.json ููุฑุฌูุน ุฅููู
    - name: ๐พ ุญูุธ package-lock.json
      uses: actions/upload-artifact@v4
      with:
        name: package-lock-${{ github.run_id }}
        path: package-lock.json
        retention-days: 7

    - name: ๐ฅ๏ธ ุชุซุจูุช ุงููุชุตูุญ ูุงูููุชุจุงุช
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          chromium-browser \
          chromium-chromedriver \
          xvfb \
          libnss3 \
          libxss1 \
          libasound2 \
          libatk-bridge2.0-0 \
          libgtk-3-0
        echo "โ ุชู ุชุซุจูุช ุงููุชุตูุญ ูุงูููุชุจุงุช"

    - name: ๐ ูุญุต ุงุชุตุงู Google Sheets
      id: sheets-check
      env:
        GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
        GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
      run: |
        if node -e "
          const { GoogleSheetsManager } = require('./src/core/google-sheets-manager');
          const manager = new GoogleSheetsManager();
          manager.initialize().then(() => {
            console.log('โ ุงุชุตุงู Google Sheets ูุดุท');
            process.exit(0);
          }).catch(error => {
            console.error('โ ูุดู ุงุชุตุงู Google Sheets:', error.message);
            process.exit(1);
          });
        "; then
          echo "connected=true" >> $GITHUB_OUTPUT
        else
          echo "connected=false" >> $GITHUB_OUTPUT
        fi

    - name: ๐ง ูุญุต ุฎุฏูุฉ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู
      id: email-check
      run: |
        if node -e "
          const axios = require('axios');
          axios.get('https://www.besttemporaryemail.com', { timeout: 10000 })
            .then(() => {
              console.log('โ ุฎุฏูุฉ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ูุชุงุญุฉ');
              process.exit(0);
            })
            .catch(error => {
              console.error('โ ุฎุฏูุฉ ุงูุจุฑูุฏ ุบูุฑ ูุชุงุญุฉ:', error.message);
              process.exit(1);
            });
        "; then
          echo "status=active" >> $GITHUB_OUTPUT
        else
          echo "status=inactive" >> $GITHUB_OUTPUT
        fi

    - name: ๐ฉบ ูุญุต ุตุญุฉ ุงููุธุงู ุงูุดุงูู
      id: health-check
      env:
        GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
        GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
      run: |
        if node src/deployment-check.js; then
          echo "status=healthy" >> $GITHUB_OUTPUT
        else
          echo "status=unhealthy" >> $GITHUB_OUTPUT
        fi

    - name: ๐ ุงูุชุญูู ุงูููุงุฆู ูู ุงูุฌุงูุฒูุฉ
      id: final-check
      run: |
        if [[ '${{ steps.health-check.outputs.status }}' == 'healthy' ]] && \
           [[ '${{ steps.sheets-check.outputs.connected }}' == 'true' ]] && \
           [[ '${{ steps.email-check.outputs.status }}' == 'active' ]]; then
          echo "ready=true" >> $GITHUB_OUTPUT
          echo "๐ ุงููุธุงู ุฌุงูุฒ ููุชุดุบูู!"
        else
          echo "ready=false" >> $GITHUB_OUTPUT
          echo "โ๏ธ ุงููุธุงู ุบูุฑ ุฌุงูุฒ - ุฑุงุฌุน ุงูุชูุงุฑูุฑ ุฃุนูุงู"
        fi

    - name: ๐ ุชูุฑูุฑ ูุญุต ุงููุธุงู
      if: always()
      run: |
        echo "๐ ุชูุฑูุฑ ูุญุต ุงููุธุงู V2"
        echo "========================"
        echo "๐ฉบ ุงูุตุญุฉ ุงูุนุงูุฉ: ${{ steps.health-check.outputs.status }}"
        echo "๐ ุงุชุตุงู Google Sheets: ${{ steps.sheets-check.outputs.connected }}"
        echo "๐ง ุฎุฏูุฉ ุงูุจุฑูุฏ: ${{ steps.email-check.outputs.status }}"
        echo "๐ ุงูุฌุงูุฒูุฉ: ${{ steps.final-check.outputs.ready }}"
        echo "========================"

  # ๐ ุงููููุฉ ุงูุฑุฆูุณูุฉ - ูุธุงู ุงูุฃุชูุชุฉ
  reddit-automation:
    name: ๐ ูุธุงู ุฃุชูุชุฉ Reddit V2
    runs-on: ubuntu-latest
    needs: system-check
    timeout-minutes: ${{ github.event.inputs.max_runtime || 360 }}
    
    # ุชุดุบูู ููุท ุฅุฐุง ูุงู ุงููุธุงู ุฌุงูุฒ
    if: needs.system-check.outputs.ready == 'true'

    strategy:
      matrix:
        node-version: [20.x]  # โญ ุงูุฅุตูุงุญ: ุชุญุฏูุซ ุฅูู Node 20

    env:
      GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
      GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
      NODE_ENV: production
      TZ: 'Asia/Riyadh'

    steps:
    - name: ๐ฅ ุงูุญุตูู ุนูู ุงูููุฏ
      uses: actions/checkout@v4

    - name: ๐๏ธ ุฅุนุฏุงุฏ Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        # โญ ุงูุฅุตูุงุญ: ุฅุฒุงูุฉ cache ูุฃู package-lock.json ุบูุฑ ููุฌูุฏ ุญุงููุงู
        # cache: 'npm'

    # โญ ุงูุฅุตูุงุญ: ุฅูุดุงุก package-lock.json ูู ูููุฉ ุงูุฃุชูุชุฉ ุฃูุถุงู
    - name: ๐ ุฅูุดุงุก package-lock.json
      run: |
        echo "๐ ุฅูุดุงุก package-lock.json..."
        npm install --package-lock-only --legacy-peer-deps
        echo "โ ุชู ุฅูุดุงุก/ุชุญุฏูุซ package-lock.json"

    - name: ๐ฆ ุชุซุจูุช ุงูุงุนุชูุงุฏูุงุช
      run: |
        npm install --legacy-peer-deps
        npm list --depth=0 || true
        echo "โ ุชู ุชุซุจูุช ุฌููุน ุงูุงุนุชูุงุฏูุงุช"

    - name: ๐ฅ๏ธ ุฅุนุฏุงุฏ ุจูุฆุฉ ุงููุชุตูุญ
      run: |
        export DISPLAY=:99
        Xvfb :99 -screen 0 1920x1080x24 &
        echo "๐ฅ๏ธ ุชู ุฅุนุฏุงุฏ ุจูุฆุฉ ุงูุนุฑุถ ุงูุงูุชุฑุงุถูุฉ"

    - name: ๐ง ุชููุฆุฉ ุงููุธุงู V2
      run: |
        echo "๐ง ุจุฏุก ุชููุฆุฉ ุงููุธุงู V2..."
        echo "๐ฏ ูุถุน ุงูุชุดุบูู: ${{ github.event.inputs.run_mode || 'normal' }}"
        echo "๐ ุงููุฏู: ${{ github.event.inputs.target_accounts || 48 }} ุญุณุงุจ"
        echo "โฐ ุงูุญุฏ ุงูุฒููู: ${{ github.event.inputs.max_runtime || 360 }} ุฏูููุฉ"

    - name: ๐ ุชุดุบูู ูุธุงู ุงูุฃุชูุชุฉ V2
      id: automation-run
      continue-on-error: true
      run: |
        set -o pipefail
        
        # ุฅุนุฏุงุฏ ูุชุบูุฑุงุช ุจูุงุกู ุนูู ูุถุน ุงูุชุดุบูู
        case "${{ github.event.inputs.run_mode || 'normal' }}" in
          "recovery")
            echo "๐ ูุถุน ุงูุชุนุงูู - ุชุดุบูู ูุฏูุฑ ุงูุชุนุงูู"
            START_CMD="node src/recovery/recovery-manager.js --mode=recovery"
            ;;
          "test")
            echo "๐งช ูุถุน ุงูุงุฎุชุจุงุฑ - ุชุดุบูู ูุญุต ุดุงูู"
            START_CMD="node src/deployment-check.js --full"
            ;;
          *)
            echo "๐ ูุถุน ุงูุชุดุบูู ุงูุนุงุฏู - ุชุดุบูู ุงููุธุงู ุงูุฑุฆูุณู"
            START_CMD="node src/main.js"
            ;;
        esac

        # ุชูููุฐ ุงูุฃูุฑ ูุน ุงูุชุนุงูู ูุน ุงูุฃุฎุทุงุก
        if $START_CMD 2>&1 | tee automation.log; then
          echo "โ ุงูุชูู ุงูุชุดุบูู ุจูุฌุงุญ"
          echo "result=success" >> $GITHUB_OUTPUT
        else
          EXIT_CODE=$?
          echo "โ ูุดู ุงูุชุดุบูู ูุน ููุฏ ุงูุฎุฑูุฌ: $EXIT_CODE"
          echo "result=failure" >> $GITHUB_OUTPUT
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
        fi

    - name: ๐ ุงูุชุนุงูู ุงูุชููุงุฆู ูู ุงููุดู
      if: steps.automation-run.outputs.result == 'failure'
      run: |
        echo "๐ ุชุดุบูู ูุธุงู ุงูุชุนุงูู ุงูุชููุงุฆู..."
        if node src/recovery/recovery-manager.js --mode=auto-recover 2>&1 | tee recovery.log; then
          echo "โ ุงูุชุนุงูู ุงูุชููุงุฆู ูุงุฌุญ"
        else
          echo "โ ูุดู ุงูุชุนุงูู ุงูุชููุงุฆู"
        fi

    - name: ๐ ุชูููุฏ ุชูุฑูุฑ ุงูุฃุฏุงุก
      if: always()
      run: |
        echo "๐ ุชูููุฏ ุชูุฑูุฑ ุฃุฏุงุก ุงููุธุงู..."
        if node -e "
          const { PerformanceMonitor } = require('./src/monitoring/performance-monitor');
          const monitor = new PerformanceMonitor();
          console.log('๐ ุชูุฑูุฑ ุงูุฃุฏุงุก ุงูููุงุฆู:');
          console.log(JSON.stringify(monitor.generatePerformanceReport(), null, 2));
        " 2>&1 | tee performance.log; then
          echo "โ ุชู ุชูููุฏ ุชูุฑูุฑ ุงูุฃุฏุงุก"
        else
          echo "โ๏ธ ูุดู ูู ุชูููุฏ ุชูุฑูุฑ ุงูุฃุฏุงุก"
        fi

    - name: ๐พ ุญูุธ ุณุฌูุงุช ุงููุธุงู
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: system-logs-v2-${{ github.run_id }}
        path: |
          automation.log
          recovery.log
          performance.log
        retention-days: 7

    - name: ๐ธ ุญูุธ ููุทุงุช ุงูุฃุฎุทุงุก
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: error-screenshots-${{ github.run_id }}
        path: |
          error_*.png
          *.png
        retention-days: 3

    - name: ๐ ุชูุฑูุฑ ุงูุชุดุบูู ุงูููุงุฆู
      if: always()
      run: |
        echo "๐ ุชูุฑูุฑ ุงูุชุดุบูู ุงูููุงุฆู V2"
        echo "=========================="
        echo "๐ ููุช ุงูุจุฏุก: $(date)"
        echo "๐ฏ ุงููุชูุฌุฉ: ${{ steps.automation-run.outputs.result || 'unknown' }}"
        echo "๐ข ููุฏ ุงูุฎุฑูุฌ: ${{ steps.automation-run.outputs.exit_code || '0' }}"
        echo "โฐ ุญุงูุฉ ุงูุชุดุบูู: ${{ job.status }}"
        echo "=========================="

  # ๐ ูุฑุงูุจุฉ ุงูุฃุฏุงุก ูุงูุชูุงุฑูุฑ
  monitoring-report:
    name: ๐ ูุฑุงูุจุฉ ุงูุฃุฏุงุก ูุงูุชูุงุฑูุฑ
    runs-on: ubuntu-latest
    needs: 
      - system-check
      - reddit-automation
    if: always()

    steps:
    - name: ๐ฅ ุงูุญุตูู ุนูู ุงูููุฏ (ูููุตูู ุฅูู GitHub Script)
      uses: actions/checkout@v4

    - name: ๐ฅ ุชุญููู ุณุฌูุงุช ุงููุธุงู
      uses: actions/download-artifact@v4
      continue-on-error: true
      with:
        pattern: system-logs-v2-*
        path: logs/
        merge-multiple: true

    - name: ๐ฅ ุชุญููู ููุทุงุช ุงูุฃุฎุทุงุก
      if: failure()
      continue-on-error: true
      uses: actions/download-artifact@v4
      with:
        pattern: error-screenshots-*
        path: screenshots/
        merge-multiple: true

    - name: ๐ ุชุญููู ุณุฌูุงุช ุงูุฃุฏุงุก
      run: |
        echo "๐ ุชุญููู ุณุฌูุงุช ุงูุฃุฏุงุก..."
        if [ -f "logs/performance.log" ]; then
          echo "๐ ุชูุฑูุฑ ุงูุฃุฏุงุก:"
          cat logs/performance.log | tail -20
        else
          echo "โ๏ธ ูุง ุชูุฌุฏ ุณุฌูุงุช ุฃุฏุงุก"
        fi

    - name: โ๏ธ ุชุญููู ุณุฌูุงุช ุงูุฃุฎุทุงุก
      if: failure()
      run: |
        echo "โ๏ธ ุชุญููู ุณุฌูุงุช ุงูุฃุฎุทุงุก..."
        if [ -f "logs/automation.log" ]; then
          echo "๐ ุงูุจุญุซ ุนู ุงูุฃุฎุทุงุก:"
          grep -i "error\|fail\|exception" logs/automation.log | tail -10 || echo "โ ูุง ุชูุฌุฏ ุฃุฎุทุงุก ุฑุฆูุณูุฉ"
        fi

    # โญ ุงูุฅุตูุงุญ: ุฅุถุงูุฉ try-catch ููุชุนุงูู ูุน ุฃุฎุทุงุก ุงูุตูุงุญูุงุช
    - name: ๐จ ุฅุดุนุงุฑ ุจุงููุชุงุฆุฌ
      if: failure()
      continue-on-error: true  # โญ ุงูุฅุถุงูุฉ: ุนุฏู ูุดู ุงูู workflow ุจุณุจุจ ุงูุฅุดุนุงุฑุงุช
      uses: actions/github-script@v6
      with:
        script: |
          try {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `๐จ ูุธุงู Reddit Automation V2 ูุญุชุงุฌ ุงูุชุจุงู - Run #${{ github.run_number }}`,
              body: `
              ## ๐ ุชูุฑูุฑ ูุธุงู ุงูุฃุชูุชุฉ V2

              **ุชูุงุตูู ุงูุชุดุบูู:**
              - ๐ ุฑูู ุงูุชุดุบูู: ${{ github.run_number }}
              - ๐ ุงูููุช: ${new Date().toLocaleString()}
              - ๐ฏ ุงููุชูุฌุฉ: ูุดู
              - ๐ ูุญุต ุงููุธุงู: ${{ needs.system-check.result }}
              - ๐ ุงูุฃุชูุชุฉ: ${{ needs.reddit-automation.result }}

              **ุงูุฅุฌุฑุงุกุงุช ุงููุทููุจุฉ:**
              1. ูุฑุงุฌุนุฉ ุณุฌูุงุช ุงููุธุงู
              2. ุงูุชุญูู ูู ุงุชุตุงู ุงูุฎุฏูุงุช
              3. ูุญุต ุชูุงุฑูุฑ ุงูุชุนุงูู

              **ุงูุฑูุงุจุท:**
              - [ุณุฌูุงุช ุงูุชุดุบูู](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${{ github.run_id }})
              - [Google Sheets](https://docs.google.com/spreadsheets/d/${{ secrets.GOOGLE_SHEET_ID }})

              *ุชู ุฅูุดุงุก ูุฐุง ุงูุฅุดุนุงุฑ ุชููุงุฆูุงู ุจูุงุณุทุฉ ูุธุงู ุงููุฑุงูุจุฉ V2*
              `
            });
            console.log('โ ุชู ุฅูุดุงุก Issue ูููุดู ุจูุฌุงุญ');
          } catch (error) {
            console.log('โ๏ธ ูุง ูููู ุฅูุดุงุก Issue:', error.message);
            console.log('๐ก ุชุฃูุฏ ูู ุชูุนูู ุตูุงุญูุฉ Issues ูู ุฅุนุฏุงุฏุงุช ุงูู Repository');
          }

    - name: ๐ ุฅุดุนุงุฑ ุงููุฌุงุญ
      if: success()
      continue-on-error: true  # โญ ุงูุฅุถุงูุฉ: ุนุฏู ูุดู ุงูู workflow ุจุณุจุจ ุงูุฅุดุนุงุฑุงุช
      uses: actions/github-script@v6
      with:
        script: |
          try {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `โ ูุธุงู Reddit Automation V2 ุงูุชูู ุจูุฌุงุญ - Run #${{ github.run_number }}`,
              body: `
              ## ๐ ุชูุฑูุฑ ุงููุฌุงุญ - ุงููุธุงู V2

              **ุชูุงุตูู ุงูุชุดุบูู:**
              - ๐ ุฑูู ุงูุชุดุบูู: ${{ github.run_number }}
              - ๐ ุงูููุช: ${new Date().toLocaleString()}
              - ๐ฏ ุงูุญุงูุฉ: ุงูุชูู ุจูุฌุงุญ
              - โก ุงูุฃุฏุงุก: ูุซุงูู

              **ุงูุฑูุงุจุท:**
              - [ุชูุงุตูู ุงูุชุดุบูู](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${{ github.run_id }})
              - [Google Sheets](https://docs.google.com/spreadsheets/d/${{ secrets.GOOGLE_SHEET_ID }})

              *ุชู ุฅูุดุงุก ูุฐุง ุงูุชูุฑูุฑ ุชููุงุฆูุงู ุจูุงุณุทุฉ ูุธุงู V2*
              `
            });
            console.log('โ ุชู ุฅูุดุงุก Issue ูููุฌุงุญ ุจูุฌุงุญ');
          } catch (error) {
            console.log('โ๏ธ ูุง ูููู ุฅูุดุงุก Issue:', error.message);
            console.log('๐ก ุชุฃูุฏ ูู ุชูุนูู ุตูุงุญูุฉ Issues ูู ุฅุนุฏุงุฏุงุช ุงูู Repository');
          }

    # โญ ุงูุฅุถุงูุฉ: ุทุจุงุนุฉ ุงูุชูุฑูุฑ ูู ุงูุณุฌูุงุช ูุจุฏูู
    - name: ๐ ุทุจุงุนุฉ ุงูุชูุฑูุฑ ูู ุงูุณุฌูุงุช
      if: always()
      run: |
        echo "================================"
        echo "๐ ุชูุฑูุฑ ุงูุชุดุบูู ุงููุงูู V2"
        echo "================================"
        echo ""
        echo "๐ ุฑูู ุงูุชุดุบูู: ${{ github.run_number }}"
        echo "๐ ุงูููุช: $(date)"
        echo "๐ ูุญุต ุงููุธุงู: ${{ needs.system-check.result }}"
        echo "๐ ุงูุฃุชูุชุฉ: ${{ needs.reddit-automation.result }}"
        echo ""
        if [[ "${{ needs.system-check.result }}" == "success" ]] && \
           [[ "${{ needs.reddit-automation.result }}" == "success" ]]; then
          echo "๐ ุงูุญุงูุฉ: ุงูุชูู ุจูุฌุงุญ"
          echo "โก ุงูุฃุฏุงุก: ูุซุงูู"
        else
          echo "๐ฏ ุงูุญุงูุฉ: ูุดู"
          echo "๐ ูุฑุฌู ูุฑุงุฌุนุฉ ุงูุณุฌูุงุช ููุชูุงุตูู"
        fi
        echo ""
        echo "๐ ุงูุฑูุงุจุท:"
        echo "   - ุณุฌูุงุช ุงูุชุดุบูู: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo "   - Google Sheets: https://docs.google.com/spreadsheets/d/${{ secrets.GOOGLE_SHEET_ID }}"
        echo ""
        echo "================================"

  # ๐งน ุชูุธูู ุงูููุงุฑุฏ
  cleanup:
    name: ๐งน ุชูุธูู ุงูููุงุฑุฏ
    runs-on: ubuntu-latest
    needs: 
      - system-check
      - reddit-automation
      - monitoring-report
    if: always()

    steps:
    - name: ๐๏ธ ุชูุธูู ุงูุนูููุงุช ุงูุนุงููุฉ
      run: |
        echo "๐งน ุชูุธูู ุงูุนูููุงุช ุงูุนุงููุฉ..."
        pkill -f chrome || true
        pkill -f chromedriver || true
        pkill -f Xvfb || true
        echo "โ ุชู ุงูุชูุธูู"

    - name: ๐๏ธ ุชูุธูู ุงูู Artifacts ุชููุงุฆูุงู
      continue-on-error: true  # โญ ุงูุฅุถุงูุฉ: ุนุฏู ูุดู ุจุณุจุจ ุงูุชูุธูู
      uses: actions/github-script@v6
      with:
        script: |
          // ุชูุธูู ุงูู Artifacts ุงููุฏููุฉ (ุฃูุฏู ูู 2 ููู)
          const twoDaysAgo = new Date();
          twoDaysAgo.setDate(twoDaysAgo.getDate() - 2);
          
          try {
            const artifacts = await github.rest.actions.listArtifactsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            
            let deletedCount = 0;
            for (const artifact of artifacts.data.artifacts) {
              if (new Date(artifact.created_at) < twoDaysAgo) {
                try {
                  await github.rest.actions.deleteArtifact({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    artifact_id: artifact.id
                  });
                  deletedCount++;
                  console.log(`๐๏ธ ุชู ุญุฐู artifact ูุฏูู: ${artifact.name}`);
                } catch (deleteError) {
                  console.log(`โ๏ธ ุชุนุฐุฑ ุญุฐู ${artifact.name}:`, deleteError.message);
                }
              }
            }
            console.log(`โ ุชู ุญุฐู ${deletedCount} artifact ูุฏูู`);
          } catch (error) {
            console.log('โ๏ธ ูุดู ูู ุชูุธูู ุงูู Artifacts ุงููุฏููุฉ:', error.message);
          }

    - name: ๐ ุชูุฑูุฑ ููุงุฆู
      if: always()
      run: |
        echo "๐ ุงูุชูุฑูุฑ ุงูููุงุฆู ููุชุดุบูู V2"
        echo "============================="
        echo "โ ูุญุต ุงููุธุงู: ${{ needs.system-check.result }}"
        echo "๐ ุงูุฃุชูุชุฉ: ${{ needs.reddit-automation.result }}"
        echo "๐ ุงููุฑุงูุจุฉ: ${{ needs.monitoring-report.result }}"
        echo "๐ ุฑูู ุงูุชุดุบูู: ${{ github.run_number }}"
        echo "============================="
        
        if [[ "${{ needs.system-check.result }}" == "success" ]] && \
           [[ "${{ needs.reddit-automation.result }}" == "success" ]]; then
          echo "๐ ุฌููุน ุงูููุงู ุงูุชููุช ุจูุฌุงุญ!"
          echo "๐ ููููู ูุฑุงุฌุนุฉ ุงููุชุงุฆุฌ ูู Google Sheets"
        else
          echo "โ๏ธ ุจุนุถ ุงูููุงู ูุงุฌูุช ูุดุงูู - ุฑุงุฌุน ุงูุณุฌูุงุช ููุชูุงุตูู"
        fi
