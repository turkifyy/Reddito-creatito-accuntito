name: ๐ Reddit Automation System V3.0 - Production (Fixed)

on:
  push:
    branches: [ main, master ]
  
  workflow_dispatch:
    inputs:
      run_mode:
        description: 'ูุถุน ุงูุชุดุบูู'
        required: true
        default: 'normal'
        type: choice
        options:
        - normal
        - recovery
        - test

permissions:
  contents: read
  issues: write
  actions: write

env:
  NODE_VERSION: '20.x'
  CHROME_VERSION: '120'
  TIMEZONE: 'Asia/Riyadh'

jobs:
  # ๐ ูุญุต ุงูุฌุงูุฒูุฉ ูุงููุธุงู
  system-check:
    name: ๐ ูุญุต ุฌุงูุฒูุฉ ุงููุธุงู V3.0
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    outputs:
      health-status: ${{ steps.health-check.outputs.status }}
      sheets-connected: ${{ steps.sheets-check.outputs.connected }}
      email-service: ${{ steps.email-check.outputs.status }}
      ready: ${{ steps.final-check.outputs.ready }}

    steps:
    - name: ๐ฅ ุงูุญุตูู ุนูู ุงูููุฏ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ๐๏ธ ุฅุนุฏุงุฏ Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: ๐ ุฅูุดุงุก package-lock.json
      run: |
        echo "๐ ุฅูุดุงุก package-lock.json..."
        npm install --package-lock-only --legacy-peer-deps
        echo "โ ุชู ุฅูุดุงุก package-lock.json"

    - name: ๐ฆ ุชุซุจูุช ุงูุงุนุชูุงุฏูุงุช ุงูุฃุณุงุณูุฉ
      run: |
        echo "๐ฆ ุจุฏุก ุชุซุจูุช ุงูุงุนุชูุงุฏูุงุช..."
        npm install --legacy-peer-deps
        echo "โ ุชู ุชุซุจูุช ุงูุงุนุชูุงุฏูุงุช"
        echo "๐ ูุงุฆูุฉ ุงูุญุฒู:"
        npm list --depth=0 || true

    - name: ๐ฅ๏ธ ุชุซุจูุช ุงููุชุตูุญ ูุงูููุชุจุงุช V3.0
      continue-on-error: false
      run: |
        echo "๐ฆ ุชุญุฏูุซ ูุงุฆูุฉ ุงูุญุฒู..."
        sudo apt-get update -qq || echo "โ๏ธ ูุดู apt update"
        
        echo "๐ ุชุซุจูุช ุงูููุชุจุงุช ุงูุฃุณุงุณูุฉ..."
        sudo apt-get install -y --no-install-recommends \
          xvfb \
          libnss3 \
          libxss1 \
          libatk-bridge2.0-0 \
          libgtk-3-0 \
          fonts-liberation \
          libappindicator3-1 \
          libu2f-udev \
          libvulkan1 \
          xdg-utils \
          wget \
          ca-certificates 2>&1 | tee /tmp/apt-install.log || {
            echo "โ๏ธ ุจุนุถ ุงูุญุฒู ูุดูุช"
            cat /tmp/apt-install.log | tail -20
          }
        
        echo "๐ ุชุซุจูุช ููุชุจุฉ ุงูุตูุช..."
        sudo apt-get install -y libasound2t64 2>/dev/null || \
        sudo apt-get install -y libasound2 2>/dev/null || \
        echo "โ๏ธ ุชุฎุทู libasound2"
        
        echo "๐ ุชุซุจูุช Chromium..."
        CHROMIUM_INSTALLED=false
        
        # ุงููุญุงููุฉ 1: apt
        if sudo apt-get install -y chromium-browser chromium-chromedriver 2>&1 | tee /tmp/chromium-apt.log; then
          echo "โ ุชู ุชุซุจูุช chromium-browser"
          CHROMIUM_INSTALLED=true
        else
          echo "โ๏ธ ูุดู apt"
          cat /tmp/chromium-apt.log | tail -10
        fi
        
        # ุงููุญุงููุฉ 2: snap
        if [ "$CHROMIUM_INSTALLED" = false ]; then
          echo "๐ ูุญุงููุฉ snap..."
          if sudo snap install chromium 2>&1 | tee /tmp/chromium-snap.log; then
            echo "โ ุชู ุชุซุจูุช chromium ุนุจุฑ snap"
            CHROMIUM_INSTALLED=true
            sudo ln -sf /snap/bin/chromium /usr/local/bin/chromium-browser || true
          else
            echo "โ๏ธ ูุดู snap"
          fi
        fi
        
        # ุงููุญุงููุฉ 3: Puppeteer
        if [ "$CHROMIUM_INSTALLED" = false ]; then
          echo "๐ฆ ุชุซุจูุช Puppeteer ุงููุฏูุฌ..."
          npm install puppeteer 2>&1 | tee /tmp/puppeteer.log || {
            echo "โ๏ธ ูุดู Puppeteer"
            cat /tmp/puppeteer.log | tail -10
          }
        fi
        
        echo ""
        echo "๐ ูุนูููุงุช ุงููุธุงู:"
        echo "   Ubuntu: $(lsb_release -d 2>/dev/null | cut -f2 || echo 'Unknown')"
        echo "   Kernel: $(uname -r)"
        echo "   Node: $(node --version)"
        echo "   NPM: $(npm --version)"
        
        echo ""
        echo "๐ ุงููุชุตูุญุงุช ุงููุชุงุญุฉ:"
        command -v chromium-browser && echo "   โ chromium-browser" || echo "   โ chromium-browser"
        command -v chromium && echo "   โ chromium" || echo "   โ chromium"
        command -v google-chrome && echo "   โ google-chrome" || echo "   โ google-chrome"
        
        echo ""
        echo "โ ุงูุชูู ุฅุนุฏุงุฏ ุงูุจูุฆุฉ"

    - name: ๐ ูุญุต ุงุชุตุงู Google Sheets V3.0
      id: sheets-check
      env:
        GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
        GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
      run: |
        echo "๐ ูุญุต ูุชุบูุฑุงุช ุจูุฆุฉ Google Sheets..."
        
        # โญ ุงูุฅุตูุงุญ: ุงุณุชุฎุฏุงู ุณูุฑูุจุช ุจุณูุท ุจุฏูุงู ูู ุงุณุชูุฑุงุฏ ูุจุงุดุฑ
        node -e "
          const hasSheetId = !!process.env.GOOGLE_SHEET_ID;
          const hasCredentials = !!process.env.GOOGLE_SERVICE_ACCOUNT_JSON;
          
          console.log('GOOGLE_SHEET_ID:', hasSheetId ? 'ููุฌูุฏ' : 'ููููุฏ');
          console.log('GOOGLE_SERVICE_ACCOUNT_JSON:', hasCredentials ? 'ููุฌูุฏ' : 'ููููุฏ');
          
          if (hasSheetId && hasCredentials) {
            console.log('โ ุฌููุน ูุชุบูุฑุงุช Google Sheets ููุฌูุฏุฉ');
            process.exit(0);
          } else {
            console.log('โ ุจุนุถ ูุชุบูุฑุงุช Google Sheets ููููุฏุฉ');
            process.exit(1);
          }
        " && echo "connected=true" >> $GITHUB_OUTPUT || echo "connected=false" >> $GITHUB_OUTPUT

    - name: ๐ง ูุญุต ุฎุฏูุฉ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู V3.0
      id: email-check
      run: |
        echo "๐ง ูุญุต ุฎุฏูุฉ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู..."
        
        # โญ ุงูุฅุตูุงุญ: ุงุณุชุฎุฏุงู curl ุจุฏูุงู ูู axios
        if curl -s --connect-timeout 10 -I https://www.besttemporaryemail.com | grep -q "200\|301\|302"; then
          echo "โ ุฎุฏูุฉ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ูุชุงุญุฉ"
          echo "status=active" >> $GITHUB_OUTPUT
        else
          echo "โ๏ธ ุฎุฏูุฉ ุงูุจุฑูุฏ ูุฏ ูุง ุชููู ูุชุงุญุฉ"
          echo "status=inactive" >> $GITHUB_OUTPUT
        fi

    - name: ๐ฉบ ูุญุต ุตุญุฉ ุงููุธุงู ุงูุดุงูู V3.0
      id: health-check
      env:
        GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
        GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
      run: |
        echo "๐ฉบ ุจุฏุก ูุญุต ุตุญุฉ ุงููุธุงู..."
        
        # โญ ุงูุฅุตูุงุญ: ุชุดุบูู deployment-check ุจุดูู ุขูู
        if node src/deployment-check.js 2>&1 | tee /tmp/health-check.log; then
          echo "โ ูุญุต ุตุญุฉ ุงููุธุงู ูุงุฌุญ"
          echo "status=healthy" >> $GITHUB_OUTPUT
        else
          echo "โ๏ธ ูุญุต ุตุญุฉ ุงููุธุงู ูุงุดู"
          echo "๐ ุขุฎุฑ 30 ุณุทุฑ ูู ุงูุณุฌู:"
          cat /tmp/health-check.log | tail -30
          echo "status=unhealthy" >> $GITHUB_OUTPUT
        fi

    - name: ๐ ุงูุชุญูู ุงูููุงุฆู ูู ุงูุฌุงูุฒูุฉ V3.0
      id: final-check
      run: |
        HEALTH="${{ steps.health-check.outputs.status }}"
        SHEETS="${{ steps.sheets-check.outputs.connected }}"
        EMAIL="${{ steps.email-check.outputs.status }}"
        
        echo "๐ ูุชุงุฆุฌ ุงููุญูุตุงุช:"
        echo "   ๐ฉบ ุงูุตุญุฉ: $HEALTH"
        echo "   ๐ Google Sheets: $SHEETS"
        echo "   ๐ง ุงูุจุฑูุฏ: $EMAIL"
        echo ""
        
        # โญ ุงูุฅุตูุงุญ: ููุทู ูุฑู ููุฌุงูุฒูุฉ
        # ูุณูุญ ุจุงูุชุดุบูู ุฅุฐุง ูุงู ุงููุญุต ุตุญู ุฃู ุฅุฐุง ูุงูุช Google Sheets ูุชุตูุฉ
        if [ "$HEALTH" = "healthy" ] || [ "$SHEETS" = "true" ]; then
          echo "ready=true" >> $GITHUB_OUTPUT
          echo "๐ ุงููุธุงู ุฌุงูุฒ ููุชุดุบูู!"
        else
          echo "ready=false" >> $GITHUB_OUTPUT
          echo "โ๏ธ ุงููุธุงู ุบูุฑ ุฌุงูุฒ - ุฑุงุฌุน ุงูุชูุงุฑูุฑ"
        fi

    - name: ๐ ุชูุฑูุฑ ูุญุต ุงููุธุงู V3.0
      if: always()
      run: |
        echo "================================"
        echo "๐ ุชูุฑูุฑ ูุญุต ุงููุธุงู V3.0"
        echo "================================"
        echo "๐ฉบ ุงูุตุญุฉ ุงูุนุงูุฉ: ${{ steps.health-check.outputs.status }}"
        echo "๐ Google Sheets: ${{ steps.sheets-check.outputs.connected }}"
        echo "๐ง ุฎุฏูุฉ ุงูุจุฑูุฏ: ${{ steps.email-check.outputs.status }}"
        echo "๐ ุงูุฌุงูุฒูุฉ: ${{ steps.final-check.outputs.ready }}"
        echo "๐ ุงูููุช: $(date)"
        echo "================================"

  # ๐ ุงููููุฉ ุงูุฑุฆูุณูุฉ
  reddit-automation:
    name: ๐ ูุธุงู ุฃุชูุชุฉ Reddit V3.0
    runs-on: ubuntu-latest
    needs: system-check
    timeout-minutes: ${{ github.event.inputs.max_runtime || 360 }}
    
    if: needs.system-check.outputs.ready == 'true'

    env:
      GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
      GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
      NODE_ENV: production
      TZ: 'Asia/Riyadh'

    steps:
    - name: ๐ฅ ุงูุญุตูู ุนูู ุงูููุฏ
      uses: actions/checkout@v4

    - name: ๐๏ธ ุฅุนุฏุงุฏ Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: ๐ฆ ุชุซุจูุช ุงูุงุนุชูุงุฏูุงุช
      run: |
        npm install --package-lock-only --legacy-peer-deps
        npm install --legacy-peer-deps
        echo "โ ุชู ุชุซุจูุช ุฌููุน ุงูุงุนุชูุงุฏูุงุช"

    - name: ๐ฅ๏ธ ุฅุนุฏุงุฏ ุจูุฆุฉ ุงููุชุตูุญ
      run: |
        export DISPLAY=:99
        Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
        sleep 2
        echo "๐ฅ๏ธ ุชู ุฅุนุฏุงุฏ ุจูุฆุฉ ุงูุนุฑุถ ุงูุงูุชุฑุงุถูุฉ"

    - name: ๐ ุชุดุบูู ูุธุงู ุงูุฃุชูุชุฉ V3.0
      id: automation-run
      continue-on-error: true
      run: |
        echo "๐ ุจุฏุก ุชุดุบูู ูุธุงู ุงูุฃุชูุชุฉ V3.0..."
        echo "๐ฏ ูุถุน ุงูุชุดุบูู: ${{ github.event.inputs.run_mode || 'normal' }}"
        
        # ุชุญุฏูุฏ ุงูุฃูุฑ ุจูุงุกู ุนูู ูุถุน ุงูุชุดุบูู
        case "${{ github.event.inputs.run_mode || 'normal' }}" in
          "recovery")
            echo "๐ ูุถุน ุงูุชุนุงูู"
            START_CMD="node src/main.js --mode=recovery"
            ;;
          "test")
            echo "๐งช ูุถุน ุงูุงุฎุชุจุงุฑ"
            START_CMD="node src/deployment-check.js"
            ;;
          *)
            echo "๐ ูุถุน ุงูุชุดุบูู ุงูุนุงุฏู"
            START_CMD="node src/main.js"
            ;;
        esac

        if $START_CMD 2>&1 | tee automation.log; then
          echo "โ ุงูุชูู ุงูุชุดุบูู ุจูุฌุงุญ"
          echo "result=success" >> $GITHUB_OUTPUT
        else
          echo "โ ูุดู ุงูุชุดุบูู"
          echo "result=failure" >> $GITHUB_OUTPUT
        fi

    - name: ๐พ ุญูุธ ุณุฌูุงุช ุงููุธุงู
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: system-logs-v3-${{ github.run_id }}
        path: |
          automation.log
          *.log
        retention-days: 7

  # ๐ ูุฑุงูุจุฉ ุงูุฃุฏุงุก
  monitoring-report:
    name: ๐ ูุฑุงูุจุฉ ุงูุฃุฏุงุก V3.0
    runs-on: ubuntu-latest
    needs: 
      - system-check
      - reddit-automation
    if: always()

    steps:
    - name: ๐ ุชูุฑูุฑ ุงูุชุดุบูู ุงูููุงุฆู
      if: always()
      run: |
        echo "================================"
        echo "๐ ุชูุฑูุฑ ุงูุชุดุบูู ุงููุงูู V3.0"
        echo "================================"
        echo ""
        echo "๐ ุฑูู ุงูุชุดุบูู: ${{ github.run_number }}"
        echo "๐ ุงูููุช: $(date)"
        echo "๐ ูุญุต ุงููุธุงู: ${{ needs.system-check.result }}"
        echo "๐ ุงูุฃุชูุชุฉ: ${{ needs.reddit-automation.result }}"
        echo ""
        
        if [ "${{ needs.system-check.result }}" = "success" ] && [ "${{ needs.reddit-automation.result }}" = "success" ]; then
          echo "๐ ุงูุญุงูุฉ: ุงูุชูู ุจูุฌุงุญ"
          echo "โก ุฌููุน ุงูููุงู ูุฌุญุช"
        elif [ "${{ needs.system-check.result }}" = "success" ]; then
          echo "โ๏ธ ุงูุญุงูุฉ: ูุญุต ุงููุธุงู ูุงุฌุญุ ุงูุฃุชูุชุฉ ุจุญุงุฌุฉ ูุฑุงุฌุนุฉ"
        else
          echo "๐ฏ ุงูุญุงูุฉ: ูุญุชุงุฌ ูุฑุงุฌุนุฉ"
          echo "๐ ุฑุงุฌุน ุงูุณุฌูุงุช ููุชูุงุตูู"
        fi
        
        echo ""
        echo "๐ ุงูุฑูุงุจุท:"
        echo "   ๐ ุณุฌูุงุช ุงูุชุดุบูู: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        if [ -n "${{ secrets.GOOGLE_SHEET_ID }}" ]; then
          echo "   ๐ Google Sheets: https://docs.google.com/spreadsheets/d/${{ secrets.GOOGLE_SHEET_ID }}"
        fi
        echo ""
        echo "================================"

  # ๐งน ุชูุธูู ุงูููุงุฑุฏ
  cleanup:
    name: ๐งน ุชูุธูู ุงูููุงุฑุฏ V3.0
    runs-on: ubuntu-latest
    needs: 
      - system-check
      - reddit-automation
      - monitoring-report
    if: always()

    steps:
    - name: ๐๏ธ ุชูุธูู ุงูุนูููุงุช ุงูุนุงููุฉ
      run: |
        echo "๐งน ุชูุธูู ุงูุนูููุงุช ุงูุนุงููุฉ..."
        pkill -f chrome 2>/dev/null || true
        pkill -f chromedriver 2>/dev/null || true
        pkill -f Xvfb 2>/dev/null || true
        sleep 1
        echo "โ ุชู ุงูุชูุธูู"

    - name: ๐ ุชูุฑูุฑ ููุงุฆู
      if: always()
      run: |
        echo "================================"
        echo "๐ ุงูุชูุฑูุฑ ุงูููุงุฆู V3.0"
        echo "================================"
        echo "โ ูุญุต ุงููุธุงู: ${{ needs.system-check.result }}"
        echo "๐ ุงูุฃุชูุชุฉ: ${{ needs.reddit-automation.result }}"
        echo "๐ ุงููุฑุงูุจุฉ: ${{ needs.monitoring-report.result }}"
        echo "๐ ุฑูู ุงูุชุดุบูู: ${{ github.run_number }}"
        echo "๐ ุงูููุช: $(date)"
        echo "================================"
        
        if [ "${{ needs.system-check.result }}" = "success" ]; then
          echo ""
          echo "๐ ุงูุชุดุบูู ุงูุชูู!"
          echo "โจ ุงููุธุงู V3.0 ูุนูู ุจุดูู ุตุญูุญ"
        else
          echo ""
          echo "โ๏ธ ุจุนุถ ุงูููุงู ูุงุฌูุช ูุดุงูู"
          echo "๐ ุฑุงุฌุน ุงูุณุฌูุงุช ุฃุนูุงู"
        fi
        echo ""
        echo "================================"
