name: ğŸš€ Reddit Automation System V2 - Production

on:
  # Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ push Ø¥Ù„Ù‰ branch main
  push:
    branches: [ main, master ]
  
  # Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ Ù…Ù† ÙˆØ§Ø¬Ù‡Ø© GitHub Actions
  workflow_dispatch:
    inputs:
      run_mode:
        description: 'ÙˆØ¶Ø¹ Ø§Ù„ØªØ´ØºÙŠÙ„'
        required: true
        default: 'normal'
        type: choice
        options:
        - normal
        - recovery
        - test
      target_accounts:
        description: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù'
        required: false
        type: number
        default: 48
      max_runtime:
        description: 'Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„ØªØ´ØºÙŠÙ„ (Ø¯Ù‚Ø§Ø¦Ù‚)'
        required: false
        type: number
        default: 360

# â­ Ø§Ù„Ø¥ØµÙ„Ø§Ø­: Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù„Ø§Ø²Ù…Ø© Ù„Ù„Ù€ workflow
permissions:
  contents: read
  issues: write
  actions: write

env:
  NODE_VERSION: '20.x'  # â­ Ø§Ù„Ø¥ØµÙ„Ø§Ø­: ØªØ­Ø¯ÙŠØ« Ø¥Ù„Ù‰ Node 20 Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© undici
  CHROME_VERSION: '120'
  TIMEZONE: 'Asia/Riyadh'

jobs:
  # ğŸ” ÙØ­Øµ Ø§Ù„Ø¬Ø§Ù‡Ø²ÙŠØ© ÙˆØ§Ù„Ù†Ø¸Ø§Ù…
  system-check:
    name: ğŸ” ÙØ­Øµ Ø¬Ø§Ù‡Ø²ÙŠØ© Ø§Ù„Ù†Ø¸Ø§Ù… V2
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    outputs:
      health-status: ${{ steps.health-check.outputs.status }}
      sheets-connected: ${{ steps.sheets-check.outputs.connected }}
      email-service: ${{ steps.email-check.outputs.status }}
      ready: ${{ steps.final-check.outputs.ready }}

    steps:
    - name: ğŸ“¥ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙˆØ¯
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ—ï¸ Ø¥Ø¹Ø¯Ø§Ø¯ Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    # â­ Ø§Ù„Ø¥ØµÙ„Ø§Ø­: Ø¥Ø¶Ø§ÙØ© Ø®Ø·ÙˆØ© Ù„ØªØ­Ø¯ÙŠØ« package-lock.json
    - name: ğŸ”„ ØªØ­Ø¯ÙŠØ« package-lock.json
      run: |
        echo "ğŸ”„ ÙØ­Øµ ÙˆØªØ­Ø¯ÙŠØ« package-lock.json..."
        if [ ! -f "package-lock.json" ]; then
          echo "âš ï¸ package-lock.json ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ - Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡"
          npm install --package-lock-only
        else
          echo "âœ… package-lock.json Ù…ÙˆØ¬ÙˆØ¯ - Ø³ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ²Ø§Ù…Ù†"
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªØ²Ø§Ù…Ù† Ø¨ÙŠÙ† package.json Ùˆ package-lock.json
          npm install --package-lock-only
        fi

    - name: ğŸ“¦ ØªØ«Ø¨ÙŠØª Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ÙŠØ§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
      run: |
        echo "ğŸ“¦ Ø¨Ø¯Ø¡ ØªØ«Ø¨ÙŠØª Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ÙŠØ§Øª..."
        # Ø§Ø³ØªØ®Ø¯Ø§Ù… npm install Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† npm ci Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø¹Ø¯Ù… Ø§Ù„ØªØ²Ø§Ù…Ù†
        npm install --legacy-peer-deps
        echo "âœ… ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ÙŠØ§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©"
        echo "ğŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø²Ù… Ø§Ù„Ù…Ø«Ø¨ØªØ©:"
        npm list --depth=0 || true

    - name: ğŸ–¥ï¸ ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØµÙØ­ ÙˆØ§Ù„Ù…ÙƒØªØ¨Ø§Øª
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          chromium-browser \
          chromium-chromedriver \
          xvfb \
          libnss3 \
          libxss1 \
          libasound2 \
          libatk-bridge2.0-0 \
          libgtk-3-0
        echo "âœ… ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØµÙØ­ ÙˆØ§Ù„Ù…ÙƒØªØ¨Ø§Øª"

    - name: ğŸ” ÙØ­Øµ Ø§ØªØµØ§Ù„ Google Sheets
      id: sheets-check
      env:
        GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
        GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
      run: |
        if node -e "
          const { GoogleSheetsManager } = require('./src/core/google-sheets-manager');
          const manager = new GoogleSheetsManager();
          manager.initialize().then(() => {
            console.log('âœ… Ø§ØªØµØ§Ù„ Google Sheets Ù†Ø´Ø·');
            process.exit(0);
          }).catch(error => {
            console.error('âŒ ÙØ´Ù„ Ø§ØªØµØ§Ù„ Google Sheets:', error.message);
            process.exit(1);
          });
        "; then
          echo "connected=true" >> $GITHUB_OUTPUT
        else
          echo "connected=false" >> $GITHUB_OUTPUT
        fi

    - name: ğŸ“§ ÙØ­Øµ Ø®Ø¯Ù…Ø© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
      id: email-check
      run: |
        if node -e "
          const axios = require('axios');
          axios.get('https://www.besttemporaryemail.com', { timeout: 10000 })
            .then(() => {
              console.log('âœ… Ø®Ø¯Ù…Ø© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…ØªØ§Ø­Ø©');
              process.exit(0);
            })
            .catch(error => {
              console.error('âŒ Ø®Ø¯Ù…Ø© Ø§Ù„Ø¨Ø±ÙŠØ¯ ØºÙŠØ± Ù…ØªØ§Ø­Ø©:', error.message);
              process.exit(1);
            });
        "; then
          echo "status=active" >> $GITHUB_OUTPUT
        else
          echo "status=inactive" >> $GITHUB_OUTPUT
        fi

    - name: ğŸ©º ÙØ­Øµ ØµØ­Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ø§Ù…Ù„
      id: health-check
      env:
        GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
        GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
      run: |
        if node src/deployment-check.js; then
          echo "status=healthy" >> $GITHUB_OUTPUT
        else
          echo "status=unhealthy" >> $GITHUB_OUTPUT
        fi

    - name: ğŸ“‹ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù…Ù† Ø§Ù„Ø¬Ø§Ù‡Ø²ÙŠØ©
      id: final-check
      run: |
        if [[ '${{ steps.health-check.outputs.status }}' == 'healthy' ]] && \
           [[ '${{ steps.sheets-check.outputs.connected }}' == 'true' ]] && \
           [[ '${{ steps.email-check.outputs.status }}' == 'active' ]]; then
          echo "ready=true" >> $GITHUB_OUTPUT
          echo "ğŸ‰ Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ´ØºÙŠÙ„!"
        else
          echo "ready=false" >> $GITHUB_OUTPUT
          echo "âš ï¸ Ø§Ù„Ù†Ø¸Ø§Ù… ØºÙŠØ± Ø¬Ø§Ù‡Ø² - Ø±Ø§Ø¬Ø¹ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø£Ø¹Ù„Ø§Ù‡"
        fi

    - name: ğŸ“Š ØªÙ‚Ø±ÙŠØ± ÙØ­Øµ Ø§Ù„Ù†Ø¸Ø§Ù…
      if: always()
      run: |
        echo "ğŸ“‹ ØªÙ‚Ø±ÙŠØ± ÙØ­Øµ Ø§Ù„Ù†Ø¸Ø§Ù… V2"
        echo "========================"
        echo "ğŸ©º Ø§Ù„ØµØ­Ø© Ø§Ù„Ø¹Ø§Ù…Ø©: ${{ steps.health-check.outputs.status }}"
        echo "ğŸ“Š Ø§ØªØµØ§Ù„ Google Sheets: ${{ steps.sheets-check.outputs.connected }}"
        echo "ğŸ“§ Ø®Ø¯Ù…Ø© Ø§Ù„Ø¨Ø±ÙŠØ¯: ${{ steps.email-check.outputs.status }}"
        echo "ğŸš€ Ø§Ù„Ø¬Ø§Ù‡Ø²ÙŠØ©: ${{ steps.final-check.outputs.ready }}"
        echo "========================"

  # ğŸš€ Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© - Ù†Ø¸Ø§Ù… Ø§Ù„Ø£ØªÙ…ØªØ©
  reddit-automation:
    name: ğŸš€ Ù†Ø¸Ø§Ù… Ø£ØªÙ…ØªØ© Reddit V2
    runs-on: ubuntu-latest
    needs: system-check
    timeout-minutes: ${{ github.event.inputs.max_runtime || 360 }}
    
    # ØªØ´ØºÙŠÙ„ ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø²
    if: needs.system-check.outputs.ready == 'true'

    strategy:
      matrix:
        node-version: [20.x]  # â­ Ø§Ù„Ø¥ØµÙ„Ø§Ø­: ØªØ­Ø¯ÙŠØ« Ø¥Ù„Ù‰ Node 20

    env:
      GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
      GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
      NODE_ENV: production
      TZ: 'Asia/Riyadh'

    steps:
    - name: ğŸ“¥ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙˆØ¯
      uses: actions/checkout@v4

    - name: ğŸ—ï¸ Ø¥Ø¹Ø¯Ø§Ø¯ Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    # â­ Ø§Ù„Ø¥ØµÙ„Ø§Ø­: Ù†ÙØ³ Ø®Ø·ÙˆØ© Ø§Ù„ØªØ­Ø¯ÙŠØ«
    - name: ğŸ”„ ØªØ­Ø¯ÙŠØ« package-lock.json
      run: |
        echo "ğŸ”„ ÙØ­Øµ ÙˆØªØ­Ø¯ÙŠØ« package-lock.json..."
        npm install --package-lock-only

    - name: ğŸ“¦ ØªØ«Ø¨ÙŠØª Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ÙŠØ§Øª
      run: |
        npm install --legacy-peer-deps
        npm list --depth=0 || true
        echo "âœ… ØªÙ… ØªØ«Ø¨ÙŠØª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ÙŠØ§Øª"

    - name: ğŸ–¥ï¸ Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ¦Ø© Ø§Ù„Ù…ØªØµÙØ­
      run: |
        export DISPLAY=:99
        Xvfb :99 -screen 0 1920x1080x24 &
        echo "ğŸ–¥ï¸ ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ¦Ø© Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©"

    - name: ğŸ”§ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… V2
      run: |
        echo "ğŸ”§ Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… V2..."
        echo "ğŸ¯ ÙˆØ¶Ø¹ Ø§Ù„ØªØ´ØºÙŠÙ„: ${{ github.event.inputs.run_mode || 'normal' }}"
        echo "ğŸ“ˆ Ø§Ù„Ù‡Ø¯Ù: ${{ github.event.inputs.target_accounts || 48 }} Ø­Ø³Ø§Ø¨"
        echo "â° Ø§Ù„Ø­Ø¯ Ø§Ù„Ø²Ù…Ù†ÙŠ: ${{ github.event.inputs.max_runtime || 360 }} Ø¯Ù‚ÙŠÙ‚Ø©"

    - name: ğŸš€ ØªØ´ØºÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„Ø£ØªÙ…ØªØ© V2
      id: automation-run
      continue-on-error: true
      run: |
        set -o pipefail
        
        # Ø¥Ø¹Ø¯Ø§Ø¯ Ù…ØªØºÙŠØ±Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ÙˆØ¶Ø¹ Ø§Ù„ØªØ´ØºÙŠÙ„
        case "${{ github.event.inputs.run_mode || 'normal' }}" in
          "recovery")
            echo "ğŸ”„ ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø§ÙÙŠ - ØªØ´ØºÙŠÙ„ Ù…Ø¯ÙŠØ± Ø§Ù„ØªØ¹Ø§ÙÙŠ"
            START_CMD="node src/recovery/recovery-manager.js --mode=recovery"
            ;;
          "test")
            echo "ğŸ§ª ÙˆØ¶Ø¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± - ØªØ´ØºÙŠÙ„ ÙØ­Øµ Ø´Ø§Ù…Ù„"
            START_CMD="node src/deployment-check.js --full"
            ;;
          *)
            echo "ğŸš€ ÙˆØ¶Ø¹ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¹Ø§Ø¯ÙŠ - ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ"
            START_CMD="node src/main.js"
            ;;
        esac

        # ØªÙ†ÙÙŠØ° Ø§Ù„Ø£Ù…Ø± Ù…Ø¹ Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
        if $START_CMD 2>&1 | tee automation.log; then
          echo "âœ… Ø§ÙƒØªÙ…Ù„ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­"
          echo "result=success" >> $GITHUB_OUTPUT
        else
          EXIT_CODE=$?
          echo "âŒ ÙØ´Ù„ Ø§Ù„ØªØ´ØºÙŠÙ„ Ù…Ø¹ ÙƒÙˆØ¯ Ø§Ù„Ø®Ø±ÙˆØ¬: $EXIT_CODE"
          echo "result=failure" >> $GITHUB_OUTPUT
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
        fi

    - name: ğŸ”„ Ø§Ù„ØªØ¹Ø§ÙÙŠ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù…Ù† Ø§Ù„ÙØ´Ù„
      if: steps.automation-run.outputs.result == 'failure'
      run: |
        echo "ğŸ”„ ØªØ´ØºÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¹Ø§ÙÙŠ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ..."
        if node src/recovery/recovery-manager.js --mode=auto-recover 2>&1 | tee recovery.log; then
          echo "âœ… Ø§Ù„ØªØ¹Ø§ÙÙŠ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù†Ø§Ø¬Ø­"
        else
          echo "âŒ ÙØ´Ù„ Ø§Ù„ØªØ¹Ø§ÙÙŠ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ"
        fi

    - name: ğŸ“Š ØªÙˆÙ„ÙŠØ¯ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø¯Ø§Ø¡
      if: always()
      run: |
        echo "ğŸ“Š ØªÙˆÙ„ÙŠØ¯ ØªÙ‚Ø±ÙŠØ± Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù†Ø¸Ø§Ù…..."
        if node -e "
          const { PerformanceMonitor } = require('./src/monitoring/performance-monitor');
          const monitor = new PerformanceMonitor();
          console.log('ğŸ“ˆ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:');
          console.log(JSON.stringify(monitor.generatePerformanceReport(), null, 2));
        " 2>&1 | tee performance.log; then
          echo "âœ… ØªÙ… ØªÙˆÙ„ÙŠØ¯ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø¯Ø§Ø¡"
        else
          echo "âš ï¸ ÙØ´Ù„ ÙÙŠ ØªÙˆÙ„ÙŠØ¯ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø¯Ø§Ø¡"
        fi

    - name: ğŸ’¾ Ø­ÙØ¸ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: system-logs-v2-${{ github.run_id }}
        path: |
          automation.log
          recovery.log
          performance.log
        retention-days: 7

    - name: ğŸ“¸ Ø­ÙØ¸ Ù„Ù‚Ø·Ø§Øª Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: error-screenshots-${{ github.run_id }}
        path: |
          error_*.png
          *.png
        retention-days: 3

    - name: ğŸ“‹ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
      if: always()
      run: |
        echo "ğŸ“‹ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ V2"
        echo "=========================="
        echo "ğŸ•’ ÙˆÙ‚Øª Ø§Ù„Ø¨Ø¯Ø¡: $(date)"
        echo "ğŸ¯ Ø§Ù„Ù†ØªÙŠØ¬Ø©: ${{ steps.automation-run.outputs.result || 'unknown' }}"
        echo "ğŸ”¢ ÙƒÙˆØ¯ Ø§Ù„Ø®Ø±ÙˆØ¬: ${{ steps.automation-run.outputs.exit_code || '0' }}"
        echo "â° Ø­Ø§Ù„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„: ${{ job.status }}"
        echo "=========================="

  # ğŸ“ˆ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø£Ø¯Ø§Ø¡ ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
  monitoring-report:
    name: ğŸ“ˆ Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø£Ø¯Ø§Ø¡ ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
    runs-on: ubuntu-latest
    needs: 
      - system-check
      - reddit-automation
    if: always()

    steps:
    - name: ğŸ“¥ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙˆØ¯ (Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ GitHub Script)
      uses: actions/checkout@v4

    - name: ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
      uses: actions/download-artifact@v4
      continue-on-error: true
      with:
        pattern: system-logs-v2-*
        path: logs/
        merge-multiple: true

    - name: ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ù„Ù‚Ø·Ø§Øª Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
      if: failure()
      continue-on-error: true
      uses: actions/download-artifact@v4
      with:
        pattern: error-screenshots-*
        path: screenshots/
        merge-multiple: true

    - name: ğŸ“Š ØªØ­Ù„ÙŠÙ„ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡
      run: |
        echo "ğŸ“Š ØªØ­Ù„ÙŠÙ„ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡..."
        if [ -f "logs/performance.log" ]; then
          echo "ğŸ“ˆ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø¯Ø§Ø¡:"
          cat logs/performance.log | tail -20
        else
          echo "âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø£Ø¯Ø§Ø¡"
        fi

    - name: âš ï¸ ØªØ­Ù„ÙŠÙ„ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
      if: failure()
      run: |
        echo "âš ï¸ ØªØ­Ù„ÙŠÙ„ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø£Ø®Ø·Ø§Ø¡..."
        if [ -f "logs/automation.log" ]; then
          echo "ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø£Ø®Ø·Ø§Ø¡:"
          grep -i "error\|fail\|exception" logs/automation.log | tail -10 || echo "âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø®Ø·Ø§Ø¡ Ø±Ø¦ÙŠØ³ÙŠØ©"
        fi

    # â­ Ø§Ù„Ø¥ØµÙ„Ø§Ø­: Ø¥Ø¶Ø§ÙØ© try-catch Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
    - name: ğŸ“¨ Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø§Ù„Ù†ØªØ§Ø¦Ø¬
      if: failure()
      continue-on-error: true  # â­ Ø§Ù„Ø¥Ø¶Ø§ÙØ©: Ø¹Ø¯Ù… ÙØ´Ù„ Ø§Ù„Ù€ workflow Ø¨Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
      uses: actions/github-script@v6
      with:
        script: |
          try {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸš¨ Ù†Ø¸Ø§Ù… Reddit Automation V2 ÙŠØ­ØªØ§Ø¬ Ø§Ù†ØªØ¨Ø§Ù‡ - Run #${{ github.run_number }}`,
              body: `
              ## ğŸ“‹ ØªÙ‚Ø±ÙŠØ± Ù†Ø¸Ø§Ù… Ø§Ù„Ø£ØªÙ…ØªØ© V2

              **ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ´ØºÙŠÙ„:**
              - ğŸ†” Ø±Ù‚Ù… Ø§Ù„ØªØ´ØºÙŠÙ„: ${{ github.run_number }}
              - ğŸ•’ Ø§Ù„ÙˆÙ‚Øª: ${new Date().toLocaleString()}
              - ğŸ¯ Ø§Ù„Ù†ØªÙŠØ¬Ø©: ÙØ´Ù„
              - ğŸ” ÙØ­Øµ Ø§Ù„Ù†Ø¸Ø§Ù…: ${{ needs.system-check.result }}
              - ğŸš€ Ø§Ù„Ø£ØªÙ…ØªØ©: ${{ needs.reddit-automation.result }}

              **Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:**
              1. Ù…Ø±Ø§Ø¬Ø¹Ø© Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
              2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø®Ø¯Ù…Ø§Øª
              3. ÙØ­Øµ ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ØªØ¹Ø§ÙÙŠ

              **Ø§Ù„Ø±ÙˆØ§Ø¨Ø·:**
              - [Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${{ github.run_id }})
              - [Google Sheets](https://docs.google.com/spreadsheets/d/${{ secrets.GOOGLE_SHEET_ID }})

              *ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨ÙˆØ§Ø³Ø·Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© V2*
              `
            });
            console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Issue Ù„Ù„ÙØ´Ù„ Ø¨Ù†Ø¬Ø§Ø­');
          } catch (error) {
            console.log('âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ù†Ø´Ø§Ø¡ Issue:', error.message);
            console.log('ğŸ’¡ ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ ØµÙ„Ø§Ø­ÙŠØ© Issues ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù€ Repository');
          }

    - name: ğŸ‰ Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù†Ø¬Ø§Ø­
      if: success()
      continue-on-error: true  # â­ Ø§Ù„Ø¥Ø¶Ø§ÙØ©: Ø¹Ø¯Ù… ÙØ´Ù„ Ø§Ù„Ù€ workflow Ø¨Ø³Ø¨Ø¨ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
      uses: actions/github-script@v6
      with:
        script: |
          try {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `âœ… Ù†Ø¸Ø§Ù… Reddit Automation V2 Ø§ÙƒØªÙ…Ù„ Ø¨Ù†Ø¬Ø§Ø­ - Run #${{ github.run_number }}`,
              body: `
              ## ğŸ‰ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ø¬Ø§Ø­ - Ø§Ù„Ù†Ø¸Ø§Ù… V2

              **ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ´ØºÙŠÙ„:**
              - ğŸ†” Ø±Ù‚Ù… Ø§Ù„ØªØ´ØºÙŠÙ„: ${{ github.run_number }}
              - ğŸ•’ Ø§Ù„ÙˆÙ‚Øª: ${new Date().toLocaleString()}
              - ğŸ¯ Ø§Ù„Ø­Ø§Ù„Ø©: Ø§ÙƒØªÙ…Ù„ Ø¨Ù†Ø¬Ø§Ø­
              - âš¡ Ø§Ù„Ø£Ø¯Ø§Ø¡: Ù…Ø«Ø§Ù„ÙŠ

              **Ø§Ù„Ø±ÙˆØ§Ø¨Ø·:**
              - [ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ´ØºÙŠÙ„](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${{ github.run_id }})
              - [Google Sheets](https://docs.google.com/spreadsheets/d/${{ secrets.GOOGLE_SHEET_ID }})

              *ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨ÙˆØ§Ø³Ø·Ø© Ù†Ø¸Ø§Ù… V2*
              `
            });
            console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Issue Ù„Ù„Ù†Ø¬Ø§Ø­ Ø¨Ù†Ø¬Ø§Ø­');
          } catch (error) {
            console.log('âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ù†Ø´Ø§Ø¡ Issue:', error.message);
            console.log('ğŸ’¡ ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ ØµÙ„Ø§Ø­ÙŠØ© Issues ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù€ Repository');
          }

    # â­ Ø§Ù„Ø¥Ø¶Ø§ÙØ©: Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª ÙƒØ¨Ø¯ÙŠÙ„
    - name: ğŸ“ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
      if: always()
      run: |
        echo "================================"
        echo "ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…Ù„ V2"
        echo "================================"
        echo ""
        echo "ğŸ†” Ø±Ù‚Ù… Ø§Ù„ØªØ´ØºÙŠÙ„: ${{ github.run_number }}"
        echo "ğŸ•’ Ø§Ù„ÙˆÙ‚Øª: $(date)"
        echo "ğŸ” ÙØ­Øµ Ø§Ù„Ù†Ø¸Ø§Ù…: ${{ needs.system-check.result }}"
        echo "ğŸš€ Ø§Ù„Ø£ØªÙ…ØªØ©: ${{ needs.reddit-automation.result }}"
        echo ""
        if [[ "${{ needs.system-check.result }}" == "success" ]] && \
           [[ "${{ needs.reddit-automation.result }}" == "success" ]]; then
          echo "ğŸ‰ Ø§Ù„Ø­Ø§Ù„Ø©: Ø§ÙƒØªÙ…Ù„ Ø¨Ù†Ø¬Ø§Ø­"
          echo "âš¡ Ø§Ù„Ø£Ø¯Ø§Ø¡: Ù…Ø«Ø§Ù„ÙŠ"
        else
          echo "ğŸ¯ Ø§Ù„Ø­Ø§Ù„Ø©: ÙØ´Ù„"
          echo "ğŸ“‹ ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù„Ù„ØªÙØ§ØµÙŠÙ„"
        fi
        echo ""
        echo "ğŸ”— Ø§Ù„Ø±ÙˆØ§Ø¨Ø·:"
        echo "   - Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØ´ØºÙŠÙ„: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        echo "   - Google Sheets: https://docs.google.com/spreadsheets/d/${{ secrets.GOOGLE_SHEET_ID }}"
        echo ""
        echo "================================"

  # ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯
  cleanup:
    name: ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯
    runs-on: ubuntu-latest
    needs: 
      - system-check
      - reddit-automation
      - monitoring-report
    if: always()

    steps:
    - name: ğŸ—‘ï¸ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù„Ù‚Ø©
      run: |
        echo "ğŸ§¹ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù„Ù‚Ø©..."
        pkill -f chrome || true
        pkill -f chromedriver || true
        pkill -f Xvfb || true
        echo "âœ… ØªÙ… Ø§Ù„ØªÙ†Ø¸ÙŠÙ"

    - name: ğŸ—‘ï¸ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù€ Artifacts ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
      continue-on-error: true  # â­ Ø§Ù„Ø¥Ø¶Ø§ÙØ©: Ø¹Ø¯Ù… ÙØ´Ù„ Ø¨Ø³Ø¨Ø¨ Ø§Ù„ØªÙ†Ø¸ÙŠÙ
      uses: actions/github-script@v6
      with:
        script: |
          // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù€ Artifacts Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Ø£Ù‚Ø¯Ù… Ù…Ù† 2 ÙŠÙˆÙ…)
          const twoDaysAgo = new Date();
          twoDaysAgo.setDate(twoDaysAgo.getDate() - 2);
          
          try {
            const artifacts = await github.rest.actions.listArtifactsForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            
            let deletedCount = 0;
            for (const artifact of artifacts.data.artifacts) {
              if (new Date(artifact.created_at) < twoDaysAgo) {
                try {
                  await github.rest.actions.deleteArtifact({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    artifact_id: artifact.id
                  });
                  deletedCount++;
                  console.log(`ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù artifact Ù‚Ø¯ÙŠÙ…: ${artifact.name}`);
                } catch (deleteError) {
                  console.log(`âš ï¸ ØªØ¹Ø°Ø± Ø­Ø°Ù ${artifact.name}:`, deleteError.message);
                }
              }
            }
            console.log(`âœ… ØªÙ… Ø­Ø°Ù ${deletedCount} artifact Ù‚Ø¯ÙŠÙ…`);
          } catch (error) {
            console.log('âš ï¸ ÙØ´Ù„ ÙÙŠ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù€ Artifacts Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©:', error.message);
          }

    - name: ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ù†Ù‡Ø§Ø¦ÙŠ
      if: always()
      run: |
        echo "ğŸ“Š Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„ØªØ´ØºÙŠÙ„ V2"
        echo "============================="
        echo "âœ… ÙØ­Øµ Ø§Ù„Ù†Ø¸Ø§Ù…: ${{ needs.system-check.result }}"
        echo "ğŸš€ Ø§Ù„Ø£ØªÙ…ØªØ©: ${{ needs.reddit-automation.result }}"
        echo "ğŸ“ˆ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©: ${{ needs.monitoring-report.result }}"
        echo "ğŸ†” Ø±Ù‚Ù… Ø§Ù„ØªØ´ØºÙŠÙ„: ${{ github.run_number }}"
        echo "============================="
        
        if [[ "${{ needs.system-check.result }}" == "success" ]] && \
           [[ "${{ needs.reddit-automation.result }}" == "success" ]]; then
          echo "ğŸ‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§ÙƒØªÙ…Ù„Øª Ø¨Ù†Ø¬Ø§Ø­!"
          echo "ğŸ“Š ÙŠÙ…ÙƒÙ†Ùƒ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙÙŠ Google Sheets"
        else
          echo "âš ï¸ Ø¨Ø¹Ø¶ Ø§Ù„Ù…Ù‡Ø§Ù… ÙˆØ§Ø¬Ù‡Øª Ù…Ø´Ø§ÙƒÙ„ - Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù„Ù„ØªÙØ§ØµÙŠÙ„"
        fi
