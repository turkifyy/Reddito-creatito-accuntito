name: ๐ Reddit Automation System V2

on:
  # ุงูุชุดุบูู ุงูุชููุงุฆู ุนูุฏ ุงูุจูุด ุฅูู ุงููุฑุน ุงูุฑุฆูุณู
  push:
    branches: [ main, master ]
  
  # ุงูุชุดุบูู ุงููุฏูู ูู ูุงุฌูุฉ GitHub Actions
  workflow_dispatch:
    inputs:
      run_mode:
        description: 'ูุถุน ุงูุชุดุบูู'
        required: true
        default: 'normal'
        type: choice
        options:
          - normal
          - recovery
          - test
      target_accounts:
        description: 'ุนุฏุฏ ุงูุญุณุงุจุงุช ุงููุณุชูุฏู'
        required: false
        type: number
        default: 48
      max_runtime:
        description: 'ุงูุญุฏ ุงูุฃูุตู ููุชุดุบูู (ุฏูุงุฆู)'
        required: false
        type: number
        default: 360

# ุฅุนุฏุงุฏ ูุชุบูุฑุงุช ุงูุจูุฆุฉ ุงูุนุงูุฉ
env:
  NODE_VERSION: '18.x'
  CHROME_VERSION: '120'
  TIMEZONE: 'Asia/Riyadh'

jobs:
  # ๐ ูุญุต ุงููุธุงู ูุงูุงุนุชูุงุฏูุงุช
  system-check:
    name: '๐ ูุญุต ุฌุงูุฒูุฉ ุงููุธุงู V2'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: '๐ฅ ุงูุญุตูู ุนูู ุงูููุฏ'
      uses: actions/checkout@v4

    - name: '๐๏ธ ุฅุนุฏุงุฏ Node.js ${{ env.NODE_VERSION }}'
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: '๐ฆ ุชุซุจูุช ุงูุงุนุชูุงุฏูุงุช'
      run: |
        npm ci
        echo "โ ุชู ุชุซุจูุช ุงูุงุนุชูุงุฏูุงุช ุงูุฃุณุงุณูุฉ"

    - name: '๐ฅ๏ธ ุชุซุจูุช Chrome ูุงูููุชุจุงุช'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          wget \
          unzip \
          xvfb \
          libnss3 \
          libxss1 \
          libasound2 \
          libatk-bridge2.0-0 \
          libgtk-3-0 \
          libgbm-dev
        echo "โ ุชู ุชุซุจูุช ุงูููุชุจุงุช ุงููุทููุจุฉ"

    - name: '๐ ูุญุต ูููู ุงููููุงุช'
      run: |
        echo "๐ ุงูุชุญูู ูู ูููู ุงููููุงุช..."
        if [ -f "package.json" ]; then
          echo "โ package.json ููุฌูุฏ"
        else
          echo "โ package.json ููููุฏ"
          exit 1
        fi
        
        if [ -f "src/main.js" ]; then
          echo "โ src/main.js ููุฌูุฏ"
        else
          echo "โ src/main.js ููููุฏ"
          exit 1
        fi
        
        if [ -d "src/core" ]; then
          echo "โ ูุฌูุฏ src/core ููุฌูุฏ"
        else
          echo "โ ูุฌูุฏ src/core ููููุฏ"
          exit 1
        fi
        
        echo "๐ ูููู ุงููููุงุช ุตุญูุญ"

    - name: '๐งช ุงุฎุชุจุงุฑ ุงูุงุณุชูุฑุงุฏุงุช'
      run: |
        echo "๐งช ุงุฎุชุจุงุฑ ุงุณุชูุฑุงุฏุงุช ุงููุธุงู..."
        if node -e "
          try {
            require('./src/main.js');
            console.log('โ ุงุณุชูุฑุงุฏ main.js ูุงุฌุญ');
          } catch (e) {
            console.error('โ ูุดู ูู ุงุณุชูุฑุงุฏ main.js:', e.message);
            process.exit(1);
          }
        "; then
          echo "โ ุฌููุน ุงูุงุณุชูุฑุงุฏุงุช ูุงุฌุญุฉ"
        else
          echo "โ ูุดู ูู ุจุนุถ ุงูุงุณุชูุฑุงุฏุงุช"
          exit 1
        fi

  # ๐ ุงููููุฉ ุงูุฑุฆูุณูุฉ - ูุธุงู ุงูุฃุชูุชุฉ
  reddit-automation:
    name: '๐ ูุธุงู ุฃุชูุชุฉ Reddit V2'
    runs-on: ubuntu-latest
    needs: system-check
    timeout-minutes: ${{ github.event.inputs.max_runtime || 360 }}
    
    env:
      GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
      GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
      NODE_ENV: production
      TZ: ${{ env.TIMEZONE }}

    steps:
    - name: '๐ฅ ุงูุญุตูู ุนูู ุงูููุฏ'
      uses: actions/checkout@v4

    - name: '๐๏ธ ุฅุนุฏุงุฏ Node.js ${{ env.NODE_VERSION }}'
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: '๐ฆ ุชุซุจูุช ุงูุงุนุชูุงุฏูุงุช'
      run: |
        npm ci
        echo "โ ุชู ุชุซุจูุช ุฌููุน ุงูุงุนุชูุงุฏูุงุช"

    - name: '๐ง ุงูุชุญูู ูู ุงูุฅุนุฏุงุฏุงุช'
      run: |
        echo "๐ง ุงูุชุญูู ูู ุฅุนุฏุงุฏุงุช ุงููุธุงู..."
        if [ -z "$GOOGLE_SHEET_ID" ]; then
          echo "โ GOOGLE_SHEET_ID ุบูุฑ ูุญุฏุฏ"
          exit 1
        else
          echo "โ GOOGLE_SHEET_ID ูุถุจูุท"
        fi
        
        if [ -z "$GOOGLE_SERVICE_ACCOUNT_JSON" ]; then
          echo "โ GOOGLE_SERVICE_ACCOUNT_JSON ุบูุฑ ูุญุฏุฏ"
          exit 1
        else
          echo "โ GOOGLE_SERVICE_ACCOUNT_JSON ูุถุจูุท"
        fi
        
        echo "๐ ุฌููุน ุงูุฅุนุฏุงุฏุงุช ุตุญูุญุฉ"

    - name: '๐ฅ๏ธ ุฅุนุฏุงุฏ ุจูุฆุฉ Chrome'
      run: |
        echo "๐ฅ๏ธ ุฌุงุฑู ุฅุนุฏุงุฏ ุจูุฆุฉ Chrome..."
        export DISPLAY=:99
        Xvfb :99 -screen 0 1920x1080x24 2>/dev/null &
        sleep 5
        echo "โ ุชู ุฅุนุฏุงุฏ ุจูุฆุฉ ุงูุนุฑุถ ุงูุงูุชุฑุงุถูุฉ"

    - name: '๐งช ุงุฎุชุจุงุฑ ุงูุงุชุตุงูุงุช'
      run: |
        echo "๐งช ุงุฎุชุจุงุฑ ุงุชุตุงูุงุช ุงููุธุงู..."
        
        # ุงุฎุชุจุงุฑ ุงุชุตุงู ุงูุฅูุชุฑูุช
        if ping -c 3 google.com &> /dev/null; then
          echo "โ ุงุชุตุงู ุงูุฅูุชุฑูุช ูุดุท"
        else
          echo "โ ูุดู ูู ุงูุงุชุตุงู ุจุงูุฅูุชุฑูุช"
          exit 1
        fi
        
        # ุงุฎุชุจุงุฑ ุงุชุตุงู Reddit
        if curl -s --head https://www.reddit.com | head -n 1 | grep "200" > /dev/null; then
          echo "โ Reddit ูุชุงุญ"
        else
          echo "โ Reddit ุบูุฑ ูุชุงุญ"
          exit 1
        fi
        
        echo "๐ ุฌููุน ุงูุงุชุตุงูุงุช ูุดุทุฉ"

    - name: '๐ ุชุดุบูู ูุธุงู ุงูุฃุชูุชุฉ V2'
      id: automation-run
      run: |
        set -e  # ุฅููุงู ุนูุฏ ุฃู ุฎุทุฃ
        
        echo "๐ ุจุฏุก ุชุดุบูู ูุธุงู Reddit Automation V2"
        echo "๐ ุงูุชุงุฑูุฎ: $(date)"
        echo "๐ฏ ุงููุถุน: ${{ github.event.inputs.run_mode || 'normal' }}"
        echo "๐ ุงููุฏู: ${{ github.event.inputs.target_accounts || 48 }} ุญุณุงุจ"
        echo "โฐ ุงูุญุฏ ุงูุฒููู: ${{ github.event.inputs.max_runtime || 360 }} ุฏูููุฉ"
        
        # ุชุญุฏูุฏ ุฃูุฑ ุงูุชุดุบูู ุจูุงุกู ุนูู ุงููุถุน
        case "${{ github.event.inputs.run_mode || 'normal' }}" in
          "recovery")
            echo "๐ ูุถุน ุงูุชุนุงูู - ุชุดุบูู ูุธุงู ุงูุชุนุงูู"
            START_CMD="npm run recover"
            ;;
          "test")
            echo "๐งช ูุถุน ุงูุงุฎุชุจุงุฑ - ุชุดุบูู ุงูุงุฎุชุจุงุฑุงุช"
            START_CMD="npm run test"
            ;;
          *)
            echo "๐ ูุถุน ุงูุชุดุบูู ุงูุนุงุฏู - ุชุดุบูู ุงููุธุงู ุงูุฑุฆูุณู"
            START_CMD="npm start"
            ;;
        esac
        
        # ุชูููุฐ ุงูุฃูุฑ ูุน ุงูุชุนุงูู ูุน ุงูุฃุฎุทุงุก
        echo "โก ุชูููุฐ: $START_CMD"
        
        if $START_CMD 2>&1 | tee automation.log; then
          echo "โ ุงูุชูู ุงูุชุดุบูู ุจูุฌุงุญ"
          echo "result=success" >> $GITHUB_OUTPUT
        else
          EXIT_CODE=$?
          echo "โ ูุดู ุงูุชุดุบูู ูุน ููุฏ ุงูุฎุฑูุฌ: $EXIT_CODE"
          echo "result=failure" >> $GITHUB_OUTPUT
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
        fi

    - name: '๐ ุงูุชุนุงูู ุงูุชููุงุฆู ูู ุงููุดู'
      if: steps.automation-run.outputs.result == 'failure'
      run: |
        echo "๐ ุชุดุบูู ูุธุงู ุงูุชุนุงูู ุงูุชููุงุฆู..."
        
        if npm run recover:auto 2>&1 | tee recovery.log; then
          echo "โ ุงูุชุนุงูู ุงูุชููุงุฆู ูุงุฌุญ"
        else
          echo "โ ูุดู ุงูุชุนุงูู ุงูุชููุงุฆู"
          echo "โ๏ธ ุณูุณุชูุฑ ุงููุธุงู ูุน ุงูุฃุฎุทุงุก"
        fi

    - name: '๐ ุชูููุฏ ุชูุฑูุฑ ุงูุฃุฏุงุก'
      if: always()
      run: |
        echo "๐ ุชูููุฏ ุชูุฑูุฑ ุฃุฏุงุก ุงููุธุงู..."
        
        if node -e "
          try {
            const { PerformanceMonitor } = require('./src/monitoring/performance-monitor');
            const monitor = new PerformanceMonitor();
            const report = monitor.generatePerformanceReport();
            console.log('๐ ุชูุฑูุฑ ุงูุฃุฏุงุก ุงูููุงุฆู:');
            console.log(JSON.stringify(report, null, 2));
          } catch (error) {
            console.log('โ๏ธ ูุดู ูู ุชูููุฏ ุชูุฑูุฑ ุงูุฃุฏุงุก:', error.message);
          }
        " 2>&1 | tee performance.log; then
          echo "โ ุชู ุชูููุฏ ุชูุฑูุฑ ุงูุฃุฏุงุก"
        else
          echo "โ๏ธ ูุดู ูู ุชูููุฏ ุชูุฑูุฑ ุงูุฃุฏุงุก"
        fi

    - name: '๐พ ุญูุธ ุณุฌูุงุช ุงููุธุงู'
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: system-logs-v2
        path: |
          *.log
          src/**/*.log
        retention-days: 7

    - name: '๐ ุชูุฑูุฑ ุงูุชุดุบูู ุงูููุงุฆู'
      if: always()
      run: |
        echo "๐ ุชูุฑูุฑ ุงูุชุดุบูู ุงูููุงุฆู V2"
        echo "=========================="
        echo "๐ ููุช ุงูุจุฏุก: $(date -d @${{ job.steps.auto-run.outcome }})"
        echo "๐ฏ ุงููุชูุฌุฉ: ${{ steps.automation-run.outputs.result || 'unknown' }}"
        echo "๐ข ููุฏ ุงูุฎุฑูุฌ: ${{ steps.automation-run.outputs.exit_code || '0' }}"
        echo "โฐ ุงููุฏุฉ: ${{ job.container.duration }}"
        echo "=========================="
        
        if [[ "${{ steps.automation-run.outputs.result }}" == "success" ]]; then
          echo "๐ ุงูุชุดุบูู ุงูุชูู ุจูุฌุงุญ!"
        else
          echo "โ๏ธ ูุงุฌู ุงูุชุดุบูู ุจุนุถ ุงููุดุงูู"
        fi

  # ๐ ุงููุฑุงูุจุฉ ูุงูุชูุงุฑูุฑ
  monitoring-report:
    name: '๐ ูุฑุงูุจุฉ ุงูุฃุฏุงุก ูุงูุชูุงุฑูุฑ'
    runs-on: ubuntu-latest
    needs: 
      - system-check
      - reddit-automation
    if: always()

    steps:
    - name: '๐ฅ ุชุญููู ุณุฌูุงุช ุงููุธุงู'
      uses: actions/download-artifact@v4
      with:
        name: system-logs-v2
        path: logs/

    - name: '๐ ุชุญููู ุณุฌูุงุช ุงูุฃุฏุงุก'
      run: |
        echo "๐ ุชุญููู ุณุฌูุงุช ุงูุฃุฏุงุก V2"
        echo "========================"
        
        if [ -f "logs/performance.log" ]; then
          echo "๐ ุขุฎุฑ 10 ุฃุณุทุฑ ูู ุชูุฑูุฑ ุงูุฃุฏุงุก:"
          tail -10 logs/performance.log || echo "โ๏ธ ูุง ุชูุฌุฏ ุจูุงูุงุช ุฃุฏุงุก"
        else
          echo "โ๏ธ ูุง ุชูุฌุฏ ุณุฌูุงุช ุฃุฏุงุก"
        fi
        
        if [ -f "logs/automation.log" ]; then
          echo "๐ ุฅุญุตุงุฆูุงุช ุณุฌู ุงูุชุดุบูู:"
          echo "   - ุฅุฌูุงูู ุงูุฃุณุทุฑ: $(wc -l < logs/automation.log || echo 0)"
          echo "   - ุงูุฃุฎุทุงุก: $(grep -i "error\|fail" logs/automation.log | wc -l || echo 0)"
          echo "   - ุงูุชุญุฐูุฑุงุช: $(grep -i "warn" logs/automation.log | wc -l || echo 0)"
        fi

    - name: '๐จ ุฅุดุนุงุฑ ุจุงููุชุงุฆุฌ'
      if: failure()
      uses: actions/github-script@v6
      with:
        script: |
          try {
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `๐จ ูุธุงู Reddit Automation V2 ูุญุชุงุฌ ุงูุชุจุงู`,
              body: `
              ## ๐ ุชูุฑูุฑ ูุธุงู ุงูุฃุชูุชุฉ V2

              **ุชูุงุตูู ุงูุชุดุบูู:**
              - ๐ ุงูููุช: ${new Date().toLocaleString()}
              - ๐ฏ ุงููุชูุฌุฉ: ูุดู
              - ๐ ุงูุฑุงุจุท: [ุนุฑุถ ุงูุชุดุบูู](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})

              **ุงูุฅุฌุฑุงุกุงุช ุงููุทููุจุฉ:**
              1. ูุฑุงุฌุนุฉ ุณุฌูุงุช ุงููุธุงู
              2. ุงูุชุญูู ูู ุงุชุตุงู ุงูุฎุฏูุงุช
              3. ูุญุต ุชูุงุฑูุฑ ุงูุชุนุงูู

              *ุชู ุฅูุดุงุก ูุฐุง ุงูุฅุดุนุงุฑ ุชููุงุฆูุงู ุจูุงุณุทุฉ ูุธุงู ุงููุฑุงูุจุฉ V2*
              `,
              labels: ['automation', 'failure']
            });
            console.log('โ ุชู ุฅุฑุณุงู ุฅุดุนุงุฑ ุงููุดู');
          } catch (error) {
            console.log('โ๏ธ ูุดู ูู ุฅุฑุณุงู ุงูุฅุดุนุงุฑ:', error.message);
          }

    - name: '๐ ุฅุดุนุงุฑ ุงููุฌุงุญ'
      if: success()
      uses: actions/github-script@v6
      with:
        script: |
          try {
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `โ ูุธุงู Reddit Automation V2 ุงูุชูู ุจูุฌุงุญ`,
              body: `
              ## ๐ ุชูุฑูุฑ ุงููุฌุงุญ - ุงููุธุงู V2

              **ุชูุงุตูู ุงูุชุดุบูู:**
              - ๐ ุงูููุช: ${new Date().toLocaleString()}
              - ๐ฏ ุงูุญุงูุฉ: ุงูุชูู ุจูุฌุงุญ
              - โก ุงูุฃุฏุงุก: ูุซุงูู

              **ุงูุฑูุงุจุท:**
              - [ุชูุงุตูู ุงูุชุดุบูู](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})

              *ุชู ุฅูุดุงุก ูุฐุง ุงูุชูุฑูุฑ ุชููุงุฆูุงู ุจูุงุณุทุฉ ูุธุงู V2*
              `,
              labels: ['automation', 'success']
            });
            console.log('โ ุชู ุฅุฑุณุงู ุฅุดุนุงุฑ ุงููุฌุงุญ');
          } catch (error) {
            console.log('โ๏ธ ูุดู ูู ุฅุฑุณุงู ุงูุฅุดุนุงุฑ:', error.message);
          }

  # ๐งน ุชูุธูู ุงูููุงุฑุฏ
  cleanup:
    name: '๐งน ุชูุธูู ุงูููุงุฑุฏ'
    runs-on: ubuntu-latest
    needs: 
      - system-check
      - reddit-automation
      - monitoring-report
    if: always()

    steps:
    - name: '๐๏ธ ุชูุธูู ุงูุนูููุงุช ุงูุนุงููุฉ'
      run: |
        echo "๐งน ุชูุธูู ุงูุนูููุงุช ุงูุนุงููุฉ..."
        pkill -f chrome 2>/dev/null || true
        pkill -f chromedriver 2>/dev/null || true
        pkill -f Xvfb 2>/dev/null || true
        pkill -f node 2>/dev/null || true
        echo "โ ุชู ุชูุธูู ุงูุนูููุงุช ุงูุนุงููุฉ"

    - name: '๐ ุงูุชูุฑูุฑ ุงูููุงุฆู'
      run: |
        echo "๐ ุงูุชูุฑูุฑ ุงูููุงุฆู ููุชุดุบูู V2"
        echo "============================="
        echo "โ ูุญุต ุงููุธุงู: ${{ needs.system-check.result }}"
        echo "๐ ุงูุฃุชูุชุฉ: ${{ needs.reddit-automation.result }}"
        echo "๐ ุงููุฑุงูุจุฉ: ${{ needs.monitoring-report.result }}"
        echo "๐ ุงููุฏุฉ ุงูุฅุฌูุงููุฉ: ${{ github.run_duration }} ุซุงููุฉ"
        echo "============================="
        
        if [[ "${{ needs.system-check.result }}" == "success" ]] && \
           [[ "${{ needs.reddit-automation.result }}" == "success" ]]; then
          echo "๐ ุฌููุน ุงูููุงู ุงูุชููุช ุจูุฌุงุญ!"
          exit 0
        else
          echo "โ๏ธ ุจุนุถ ุงูููุงู ูุงุฌูุช ูุดุงูู - ุฑุงุฌุน ุงูุณุฌูุงุช"
          exit 0  # ูุฎุฑุฌ ุจุตูุฑ ูุชุฌูุจ ูุดู Workflow ูุงูู
        fi
