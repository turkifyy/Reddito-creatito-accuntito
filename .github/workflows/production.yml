name: ๐ Reddit Automation System V2 - Production

on:
  # ุงูุชุดุบูู ุงูุชููุงุฆู ุนูุฏ push ุฅูู branch main
  push:
    branches: [ main, master ]
    paths-ignore:
      - '**.md'
      - '**.txt'
      - '.gitignore'
      - 'LICENSE'
  
  # ุงูุชุดุบูู ุงููุฏูู ูู ูุงุฌูุฉ GitHub Actions
  workflow_dispatch:
    inputs:
      run_mode:
        description: 'ูุถุน ุงูุชุดุบูู'
        required: true
        default: 'normal'
        type: choice
        options:
        - normal
        - recovery
        - test
        - cleanup
      target_accounts:
        description: 'ุนุฏุฏ ุงูุญุณุงุจุงุช ุงููุณุชูุฏู'
        required: false
        type: number
        default: 48
      max_runtime:
        description: 'ุงูุญุฏ ุงูุฃูุตู ููุชุดุบูู (ุฏูุงุฆู)'
        required: false
        type: number
        default: 360
      enable_debug:
        description: 'ุชูุนูู ูุถุน ุงูุชุตุญูุญ'
        required: false
        type: boolean
        default: false

# ุฅุนุฏุงุฏ ูุชุบูุฑุงุช ุงูุจูุฆุฉ ุงูุนุงูุฉ
env:
  NODE_VERSION: '18.x'
  CHROME_VERSION: '120'
  TIMEZONE: 'Asia/Riyadh'
  WORKING_DIRECTORY: '.'
  ARTIFACT_RETENTION_DAYS: 7

# ุงูุชุฎุฒูู ุงููุคูุช ูุชุญุณูู ุงูุฃุฏุงุก
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ๐ ูุญุต ุงูุฌุงูุฒูุฉ ูุงููุธุงู
  system-check:
    name: ๐ ูุญุต ุฌุงูุฒูุฉ ุงููุธุงู V2
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      health-status: ${{ steps.health-check.outputs.status }}
      sheets-connected: ${{ steps.sheets-check.outputs.connected }}
      email-service: ${{ steps.email-check.outputs.status }}
      browser-ready: ${{ steps.browser-check.outputs.ready }}
      system-ready: ${{ steps.final-check.outputs.ready }}
      node-version: ${{ steps.node-check.outputs.version }}

    steps:
    - name: ๐ฅ ุงูุญุตูู ุนูู ุงูููุฏ
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        show-progress: false

    - name: ๐๏ธ ุฅุนุฏุงุฏ Node.js ${{ env.NODE_VERSION }}
      id: node-check
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: '**/package-lock.json'

    - name: ๐ฆ ุชุซุจูุช ุงูุงุนุชูุงุฏูุงุช ุงูุฃุณุงุณูุฉ
      run: |
        echo "๐ฆ ุชุซุจูุช ุงูุงุนุชูุงุฏูุงุช ุงูุฃุณุงุณูุฉ..."
        npm ci --production --no-audit --no-fund
        echo "โ ุชู ุชุซุจูุช ุงูุงุนุชูุงุฏูุงุช ุงูุฃุณุงุณูุฉ"

    - name: ๐ฅ๏ธ ุชุซุจูุช ุงููุชุตูุญ ูุงูููุชุจุงุช
      id: browser-check
      run: |
        echo "๐ฅ๏ธ ุชุซุจูุช ุงููุชุตูุญ ูุงูููุชุจุงุช..."
        sudo apt-get update -qq
        sudo apt-get install -y -qq \
          chromium-browser \
          chromium-chromedriver \
          xvfb \
          libnss3 \
          libxss1 \
          libasound2 \
          libatk-bridge2.0-0 \
          libgtk-3-0 \
          fonts-liberation \
          libappindicator3-1 \
          xdg-utils
        
        # ุงูุชุญูู ูู ุชุซุจูุช ุงููุชุตูุญ
        if chromium-browser --version; then
          echo "โ ุงููุชุตูุญ ูุซุจุช ุจูุฌุงุญ"
          echo "ready=true" >> $GITHUB_OUTPUT
        else
          echo "โ ูุดู ูู ุชุซุจูุช ุงููุชุตูุญ"
          echo "ready=false" >> $GITHUB_OUTPUT
        fi

    - name: ๐ ูุญุต ุงุชุตุงู Google Sheets
      id: sheets-check
      env:
        GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
        GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
      run: |
        echo "๐ ูุญุต ุงุชุตุงู Google Sheets..."
        
        # ุฅูุดุงุก ููู ุงุฎุชุจุงุฑ ุจุณูุท
        cat > test-sheets.js << 'EOF'
        const { GoogleSheetsManager } = require('./src/core/google-sheets-manager');
        
        async function testConnection() {
          try {
            const manager = new GoogleSheetsManager();
            await manager.initialize();
            console.log('โ ุงุชุตุงู Google Sheets ูุดุท');
            return true;
          } catch (error) {
            console.error('โ ูุดู ุงุชุตุงู Google Sheets:', error.message);
            return false;
          }
        }
        
        testConnection().then(success => {
          process.exit(success ? 0 : 1);
        });
        EOF
        
        if node test-sheets.js; then
          echo "connected=true" >> $GITHUB_OUTPUT
        else
          echo "connected=false" >> $GITHUB_OUTPUT
        fi
        
        # ุชูุธูู ููู ุงูุงุฎุชุจุงุฑ
        rm -f test-sheets.js

    - name: ๐ง ูุญุต ุฎุฏูุฉ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู
      id: email-check
      run: |
        echo "๐ง ูุญุต ุฎุฏูุฉ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู..."
        
        cat > test-email.js << 'EOF'
        const axios = require('axios');
        
        async function testEmailService() {
          try {
            const response = await axios.get('https://www.besttemporaryemail.com', { 
              timeout: 10000,
              headers: {
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
              }
            });
            
            if (response.status === 200) {
              console.log('โ ุฎุฏูุฉ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ูุชุงุญุฉ');
              return true;
            } else {
              console.log('โ ุฎุฏูุฉ ุงูุจุฑูุฏ ุบูุฑ ูุชุงุญุฉ - ุญุงูุฉ ุบูุฑ ูุชููุนุฉ:', response.status);
              return false;
            }
          } catch (error) {
            console.error('โ ุฎุฏูุฉ ุงูุจุฑูุฏ ุบูุฑ ูุชุงุญุฉ:', error.message);
            return false;
          }
        }
        
        testEmailService().then(success => {
          process.exit(success ? 0 : 1);
        });
        EOF
        
        if node test-email.js; then
          echo "status=active" >> $GITHUB_OUTPUT
        else
          echo "status=inactive" >> $GITHUB_OUTPUT
        fi
        
        rm -f test-email.js

    - name: ๐ฉบ ูุญุต ุตุญุฉ ุงููุธุงู ุงูุดุงูู
      id: health-check
      env:
        GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
        GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
        NODE_ENV: production
      run: |
        echo "๐ฉบ ูุญุต ุตุญุฉ ุงููุธุงู ุงูุดุงูู..."
        
        if node src/deployment-check.js --quick; then
          echo "status=healthy" >> $GITHUB_OUTPUT
        else
          echo "status=unhealthy" >> $GITHUB_OUTPUT
        fi

    - name: ๐ ุงูุชุญูู ุงูููุงุฆู ูู ุงูุฌุงูุฒูุฉ
      id: final-check
      run: |
        echo "๐ ุงูุชุญูู ุงูููุงุฆู ูู ุงูุฌุงูุฒูุฉ..."
        
        if [[ '${{ steps.health-check.outputs.status }}' == 'healthy' ]] && \
           [[ '${{ steps.sheets-check.outputs.connected }}' == 'true' ]] && \
           [[ '${{ steps.email-check.outputs.status }}' == 'active' ]] && \
           [[ '${{ steps.browser-check.outputs.ready }}' == 'true' ]]; then
          echo "ready=true" >> $GITHUB_OUTPUT
          echo "๐ ุงููุธุงู ุฌุงูุฒ ููุชุดุบูู!"
        else
          echo "ready=false" >> $GITHUB_OUTPUT
          echo "โ๏ธ ุงููุธุงู ุบูุฑ ุฌุงูุฒ - ุฑุงุฌุน ุงูุชูุงุฑูุฑ ุฃุนูุงู"
        fi

    - name: ๐ ุชูุฑูุฑ ูุญุต ุงููุธุงู
      if: always()
      run: |
        echo "๐ ุชูุฑูุฑ ูุญุต ุงููุธุงู V2"
        echo "========================"
        echo "๐ฉบ ุงูุตุญุฉ ุงูุนุงูุฉ: ${{ steps.health-check.outputs.status }}"
        echo "๐ ุงุชุตุงู Google Sheets: ${{ steps.sheets-check.outputs.connected }}"
        echo "๐ง ุฎุฏูุฉ ุงูุจุฑูุฏ: ${{ steps.email-check.outputs.status }}"
        echo "๐ฅ๏ธ ุงููุชุตูุญ: ${{ steps.browser-check.outputs.ready }}"
        echo "๐ ุงูุฌุงูุฒูุฉ: ${{ steps.final-check.outputs.ready }}"
        echo "๐ข Node.js: ${{ steps.node-check.outputs.version }}"
        echo "========================"

  # ๐ ุงููููุฉ ุงูุฑุฆูุณูุฉ - ูุธุงู ุงูุฃุชูุชุฉ
  reddit-automation:
    name: ๐ ูุธุงู ุฃุชูุชุฉ Reddit V2
    runs-on: ubuntu-latest
    needs: system-check
    timeout-minutes: ${{ github.event.inputs.max_runtime || 360 }}
    
    # ุชุดุบูู ููุท ุฅุฐุง ูุงู ุงููุธุงู ุฌุงูุฒ
    if: needs.system-check.outputs.ready == 'true'

    env:
      GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
      GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
      NODE_ENV: production
      TZ: ${{ env.TIMEZONE }}
      ENABLE_DEBUG: ${{ github.event.inputs.enable_debug || false }}
      TARGET_ACCOUNTS: ${{ github.event.inputs.target_accounts || 48 }}

    steps:
    - name: ๐ฅ ุงูุญุตูู ุนูู ุงูููุฏ
      uses: actions/checkout@v4
      with:
        ref: ${{ github.ref }}

    - name: ๐๏ธ ุฅุนุฏุงุฏ Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: '**/package-lock.json'

    - name: ๐ฆ ุชุซุจูุช ุงูุงุนุชูุงุฏูุงุช ุงููุงููุฉ
      run: |
        echo "๐ฆ ุชุซุจูุช ุงูุงุนุชูุงุฏูุงุช ุงููุงููุฉ..."
        npm ci --no-audit --no-fund
        npm list --depth=0
        echo "โ ุชู ุชุซุจูุช ุฌููุน ุงูุงุนุชูุงุฏูุงุช"

    - name: ๐ฅ๏ธ ุฅุนุฏุงุฏ ุจูุฆุฉ ุงููุชุตูุญ
      run: |
        echo "๐ฅ๏ธ ุฅุนุฏุงุฏ ุจูุฆุฉ ุงููุชุตูุญ..."
        export DISPLAY=:99
        Xvfb :99 -screen 0 1920x1080x24 -ac &
        sleep 5
        echo "โ ุชู ุฅุนุฏุงุฏ ุจูุฆุฉ ุงูุนุฑุถ ุงูุงูุชุฑุงุถูุฉ"

    - name: ๐ง ุงูุชุญุถูุฑ ููุชุดุบูู
      id: setup
      run: |
        echo "๐ง ุงูุชุญุถูุฑ ููุชุดุบูู V2..."
        echo "๐ฏ ูุถุน ุงูุชุดุบูู: ${{ github.event.inputs.run_mode || 'normal' }}"
        echo "๐ ุงููุฏู: $TARGET_ACCOUNTS ุญุณุงุจ"
        echo "โฐ ุงูุญุฏ ุงูุฒููู: ${{ github.event.inputs.max_runtime || 360 }} ุฏูููุฉ"
        echo "๐ ุงูุชุตุญูุญ: $ENABLE_DEBUG"
        
        # ุฅูุดุงุก ูุฌูุฏุงุช ุถุฑูุฑูุฉ
        mkdir -p logs screenshots tmp
        
        # ุฅุนุฏุงุฏ ูุชุบูุฑุงุช ุงูุฅุฎุฑุงุฌ
        echo "start_time=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT
        echo "run_mode=${{ github.event.inputs.run_mode || 'normal' }}" >> $GITHUB_OUTPUT

    - name: ๐ ุชุดุบูู ูุธุงู ุงูุฃุชูุชุฉ V2
      id: automation-run
      continue-on-error: true
      run: |
        set -o pipefail
        
        echo "๐ ุจุฏุก ุชุดุบูู ูุธุงู ุงูุฃุชูุชุฉ V2..."
        
        # ุชุญุฏูุฏ ุฃูุฑ ุงูุชุดุบูู ุจูุงุกู ุนูู ุงููุถุน
        case "${{ github.event.inputs.run_mode || 'normal' }}" in
          "recovery")
            echo "๐ ูุถุน ุงูุชุนุงูู - ุชุดุบูู ูุฏูุฑ ุงูุชุนุงูู"
            START_CMD="node src/recovery/recovery-manager.js --mode=recovery --target=$TARGET_ACCOUNTS"
            ;;
          "test")
            echo "๐งช ูุถุน ุงูุงุฎุชุจุงุฑ - ุชุดุบูู ูุญุต ุดุงูู"
            START_CMD="node src/test-system.js --full --target=5"
            ;;
          "cleanup")
            echo "๐งน ูุถุน ุงูุชูุธูู - ุชูุธูู ุงููุธุงู"
            START_CMD="node scripts/cleanup.js --force"
            ;;
          *)
            echo "๐ ูุถุน ุงูุชุดุบูู ุงูุนุงุฏู - ุชุดุบูู ุงููุธุงู ุงูุฑุฆูุณู"
            START_CMD="node src/main.js --target=$TARGET_ACCOUNTS"
            ;;
        esac
        
        # ุฅุถุงูุฉ flags ุงูุชุตุญูุญ ุฅุฐุง ูุทููุจ
        if [[ "$ENABLE_DEBUG" == "true" ]]; then
          START_CMD="$START_CMD --debug --verbose"
        fi
        
        echo "๐ง ุงูุฃูุฑ: $START_CMD"
        
        # ุชูููุฐ ุงูุฃูุฑ ูุน ุงูุชุนุงูู ูุน ุงูุฃุฎุทุงุก ูุงูุชุณุฌูู
        if timeout $(({{ github.event.inputs.max_runtime || 360 }} - 10))m $START_CMD 2>&1 | tee automation.log; then
          echo "โ ุงูุชูู ุงูุชุดุบูู ุจูุฌุงุญ"
          echo "result=success" >> $GITHUB_OUTPUT
          echo "exit_code=0" >> $GITHUB_OUTPUT
        else
          EXIT_CODE=$?
          echo "โ ูุดู ุงูุชุดุบูู ูุน ููุฏ ุงูุฎุฑูุฌ: $EXIT_CODE"
          echo "result=failure" >> $GITHUB_OUTPUT
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
        fi
        
        echo "end_time=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT

    - name: ๐ ุงูุชุนุงูู ุงูุชููุงุฆู ูู ุงููุดู
      if: steps.automation-run.outputs.result == 'failure'
      run: |
        echo "๐ ุชุดุบูู ูุธุงู ุงูุชุนุงูู ุงูุชููุงุฆู..."
        
        # ุงูุชุญูู ูู ูุฌูุฏ ูููุงุช ุงููุธุงู ุฃููุงู
        if [ -f "src/recovery/recovery-manager.js" ]; then
          if node src/recovery/recovery-manager.js --mode=auto-recover --quick 2>&1 | tee recovery.log; then
            echo "โ ุงูุชุนุงูู ุงูุชููุงุฆู ูุงุฌุญ"
          else
            echo "โ ูุดู ุงูุชุนุงูู ุงูุชููุงุฆู"
          fi
        else
          echo "โ๏ธ ููู ุงูุชุนุงูู ุบูุฑ ููุฌูุฏ - ุชุฎุทู ุงูุชุนุงูู ุงูุชููุงุฆู"
        fi

    - name: ๐ ุชูููุฏ ุชูุฑูุฑ ุงูุฃุฏุงุก
      if: always()
      continue-on-error: true
      run: |
        echo "๐ ุชูููุฏ ุชูุฑูุฑ ุฃุฏุงุก ุงููุธุงู..."
        
        # ุงูุชุญูู ูู ูุฌูุฏ ูููุงุช ุงููุฑุงูุจุฉ ุฃููุงู
        if [ -f "src/monitoring/performance-monitor.js" ]; then
          if node -e "
            try {
              const { PerformanceMonitor } = require('./src/monitoring/performance-monitor');
              const monitor = new PerformanceMonitor();
              const report = monitor.generatePerformanceReport();
              console.log('๐ ุชูุฑูุฑ ุงูุฃุฏุงุก ุงูููุงุฆู:');
              console.log(JSON.stringify(report, null, 2));
            } catch (error) {
              console.error('โ ูุดู ูู ุชูููุฏ ุชูุฑูุฑ ุงูุฃุฏุงุก:', error.message);
            }
          " 2>&1 | tee performance.log; then
            echo "โ ุชู ุชูููุฏ ุชูุฑูุฑ ุงูุฃุฏุงุก"
          else
            echo "โ๏ธ ูุดู ูู ุชูููุฏ ุชูุฑูุฑ ุงูุฃุฏุงุก"
          fi
        else
          echo "โ๏ธ ููู ูุฑุงูุจุฉ ุงูุฃุฏุงุก ุบูุฑ ููุฌูุฏ - ุชุฎุทู ุงูุชูุฑูุฑ"
        fi

    - name: ๐พ ุญูุธ ุณุฌูุงุช ุงููุธุงู
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: system-logs-v2-${{ github.run_id }}-${{ github.run_attempt }}
        path: |
          *.log
          logs/
          src/**/*.log
        retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}
        if-no-files-found: ignore
        compression-level: 9

    - name: ๐ธ ุญูุธ ููุทุงุช ุงูุฃุฎุทุงุก
      if: failure() && steps.automation-run.outputs.result == 'failure'
      uses: actions/upload-artifact@v4
      with:
        name: error-screenshots-${{ github.run_id }}-${{ github.run_attempt }}
        path: |
          error_*.png
          screenshots/
          *.png
        retention-days: 3
        if-no-files-found: ignore

    - name: ๐ ุญูุธ ุจูุงูุงุช ุงููุธุงู
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: system-data-${{ github.run_id }}-${{ github.run_attempt }}
        path: |
          data/
          tmp/system-*
          config/*.json
        retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}
        if-no-files-found: ignore

    - name: ๐ ุชูุฑูุฑ ุงูุชุดุบูู ุงูููุงุฆู
      if: always()
      run: |
        echo "๐ ุชูุฑูุฑ ุงูุชุดุบูู ุงูููุงุฆู V2"
        echo "=========================="
        echo "๐ ููุช ุงูุจุฏุก: ${{ steps.setup.outputs.start_time }}"
        echo "๐ ููุช ุงูููุงูุฉ: ${{ steps.automation-run.outputs.end_time || 'ุบูุฑ ูุญุฏุฏ' }}"
        echo "๐ฏ ุงููุชูุฌุฉ: ${{ steps.automation-run.outputs.result || 'unknown' }}"
        echo "๐ข ููุฏ ุงูุฎุฑูุฌ: ${{ steps.automation-run.outputs.exit_code || '0' }}"
        echo "๐ ุงููุถุน: ${{ steps.setup.outputs.run_mode }}"
        echo "๐ ุงููุฏู: $TARGET_ACCOUNTS"
        echo "=========================="

  # ๐ ูุฑุงูุจุฉ ุงูุฃุฏุงุก ูุงูุชูุงุฑูุฑ
  monitoring-report:
    name: ๐ ูุฑุงูุจุฉ ุงูุฃุฏุงุก ูุงูุชูุงุฑูุฑ
    runs-on: ubuntu-latest
    needs: 
      - system-check
      - reddit-automation
    if: always()

    steps:
    - name: ๐ฅ ุชุญููู ุณุฌูุงุช ุงููุธุงู
      uses: actions/download-artifact@v4
      with:
        name: system-logs-v2-${{ github.run_id }}-${{ github.run_attempt }}
        path: logs/
        if-no-files-found: ignore

    - name: ๐ฅ ุชุญููู ููุทุงุช ุงูุฃุฎุทุงุก
      if: failure()
      uses: actions/download-artifact@v4
      with:
        name: error-screenshots-${{ github.run_id }}-${{ github.run_attempt }}
        path: screenshots/
        if-no-files-found: ignore

    - name: ๐ฅ ุชุญููู ุจูุงูุงุช ุงููุธุงู
      uses: actions/download-artifact@v4
      with:
        name: system-data-${{ github.run_id }}-${{ github.run_attempt }}
        path: data/
        if-no-files-found: ignore

    - name: ๐ ุชุญููู ุณุฌูุงุช ุงูุฃุฏุงุก
      if: always()
      run: |
        echo "๐ ุชุญููู ุณุฌูุงุช ุงูุฃุฏุงุก..."
        
        if [ -f "logs/performance.log" ]; then
          echo "๐ ุชูุฑูุฑ ุงูุฃุฏุงุก:"
          cat logs/performance.log | tail -20 || echo "โ๏ธ ูุง ูููู ูุฑุงุกุฉ ููู ุงูุฃุฏุงุก"
        else
          echo "โ๏ธ ูุง ุชูุฌุฏ ุณุฌูุงุช ุฃุฏุงุก"
        fi
        
        if [ -f "logs/automation.log" ]; then
          echo "๐ ุขุฎุฑ 10 ุฃุณุทุฑ ูู ุณุฌู ุงูุชุดุบูู:"
          tail -10 logs/automation.log || echo "โ๏ธ ูุง ูููู ูุฑุงุกุฉ ุณุฌู ุงูุชุดุบูู"
        fi

    - name: โ๏ธ ุชุญููู ุณุฌูุงุช ุงูุฃุฎุทุงุก
      if: failure()
      run: |
        echo "โ๏ธ ุชุญููู ุณุฌูุงุช ุงูุฃุฎุทุงุก..."
        
        if [ -f "logs/automation.log" ]; then
          echo "๐ ุงูุจุญุซ ุนู ุงูุฃุฎุทุงุก ูู ุณุฌู ุงูุชุดุบูู:"
          grep -i -A 2 -B 2 "error\|fail\|exception\|uncaught" logs/automation.log | tail -20 || echo "โ ูุง ุชูุฌุฏ ุฃุฎุทุงุก ุฑุฆูุณูุฉ"
        fi
        
        if [ -f "logs/recovery.log" ]; then
          echo "๐ ุณุฌู ุงูุชุนุงูู:"
          tail -10 logs/recovery.log || echo "โ๏ธ ูุง ูููู ูุฑุงุกุฉ ุณุฌู ุงูุชุนุงูู"
        fi

    - name: ๐จ ุฅุดุนุงุฑ ุจุงููุชุงุฆุฌ (ูุดู)
      if: failure() && needs.reddit-automation.result == 'failure'
      uses: actions/github-script@v6
      env:
        GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
      run: |
        const { system-check, reddit-automation } = context.job;
        const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
        
        github.rest.issues.create({
          owner: context.repo.owner,
          repo: context.repo.repo,
          title: `๐จ ูุธุงู Reddit Automation V2 ูุญุชุงุฌ ุงูุชุจุงู - ุงูุชุดุบูู #${context.runNumber}`,
          body: `
          ## ๐ ุชูุฑูุฑ ูุธุงู ุงูุฃุชูุชุฉ V2

          **ุชูุงุตูู ุงูุชุดุบูู:**
          - ๐ ุงูููุช: ${new Date().toLocaleString()}
          - ๐ฏ ุงููุชูุฌุฉ: ูุดู
          - ๐ ูุญุต ุงููุธุงู: ${system-check.result}
          - ๐ ุงูุฃุชูุชุฉ: ${reddit-automation.result}
          - ๐ข ุฑูู ุงูุชุดุบูู: ${context.runNumber}

          **ุงูุฅุฌุฑุงุกุงุช ุงููุทููุจุฉ:**
          1. ูุฑุงุฌุนุฉ ุณุฌูุงุช ุงููุธุงู
          2. ุงูุชุญูู ูู ุงุชุตุงู ุงูุฎุฏูุงุช
          3. ูุญุต ุชูุงุฑูุฑ ุงูุชุนุงูู

          **ุงูุฑูุงุจุท:**
          - [ุณุฌูุงุช ุงูุชุดุบูู](${runUrl})
          - [Google Sheets](https://docs.google.com/spreadsheets/d/${process.env.GOOGLE_SHEET_ID})

          *ุชู ุฅูุดุงุก ูุฐุง ุงูุฅุดุนุงุฑ ุชููุงุฆูุงู ุจูุงุณุทุฉ ูุธุงู ุงููุฑุงูุจุฉ V2*
          `
        });

    - name: ๐ ุฅุดุนุงุฑ ุงููุฌุงุญ
      if: success() && needs.reddit-automation.result == 'success'
      uses: actions/github-script@v6
      env:
        GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
      run: |
        const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
        
        github.rest.issues.create({
          owner: context.repo.owner,
          repo: context.repo.repo,
          title: `โ ูุธุงู Reddit Automation V2 ุงูุชูู ุจูุฌุงุญ - ุงูุชุดุบูู #${context.runNumber}`,
          body: `
          ## ๐ ุชูุฑูุฑ ุงููุฌุงุญ - ุงููุธุงู V2

          **ุชูุงุตูู ุงูุชุดุบูู:**
          - ๐ ุงูููุช: ${new Date().toLocaleString()}
          - ๐ฏ ุงูุญุงูุฉ: ุงูุชูู ุจูุฌุงุญ
          - โก ุงูุฃุฏุงุก: ูุซุงูู
          - ๐ข ุฑูู ุงูุชุดุบูู: ${context.runNumber}

          **ุงูุฑูุงุจุท:**
          - [ุชูุงุตูู ุงูุชุดุบูู](${runUrl})
          - [Google Sheets](https://docs.google.com/spreadsheets/d/${process.env.GOOGLE_SHEET_ID})

          *ุชู ุฅูุดุงุก ูุฐุง ุงูุชูุฑูุฑ ุชููุงุฆูุงู ุจูุงุณุทุฉ ูุธุงู V2*
          `
        });

    - name: ๐ ุฅูุดุงุก ุชูุฑูุฑ ููุฌุฒ
      if: always()
      run: |
        echo "๐ ุงูุชูุฑูุฑ ุงูููุฌุฒ ููุชุดุบูู V2"
        echo "============================"
        echo "โ ูุญุต ุงููุธุงู: ${{ needs.system-check.result }}"
        echo "๐ ุงูุฃุชูุชุฉ: ${{ needs.reddit-automation.result }}"
        echo "๐ ุงููุฑุงูุจุฉ: ${{ job.status }}"
        echo "๐ ุฑูู ุงูุชุดุบูู: ${{ github.run_number }}"
        echo "๐ ูุญุงููุฉ ุงูุชุดุบูู: ${{ github.run_attempt }}"
        echo "============================"

  # ๐งน ุชูุธูู ุงูููุงุฑุฏ
  cleanup:
    name: ๐งน ุชูุธูู ุงูููุงุฑุฏ
    runs-on: ubuntu-latest
    needs: 
      - system-check
      - reddit-automation
      - monitoring-report
    if: always()

    steps:
    - name: ๐๏ธ ุชูุธูู ุงูุนูููุงุช ุงูุนุงููุฉ
      run: |
        echo "๐งน ุชูุธูู ุงูุนูููุงุช ุงูุนุงููุฉ..."
        pkill -f chrome || true
        pkill -f chromedriver || true
        pkill -f Xvfb || true
        pkill -f node || true
        echo "โ ุชู ุชูุธูู ุงูุนูููุงุช"

    - name: ๐งฝ ุชูุธูู ุงููููุงุช ุงููุคูุชุฉ
      run: |
        echo "๐งฝ ุชูุธูู ุงููููุงุช ุงููุคูุชุฉ..."
        rm -rf tmp/.* tmp/* || true
        rm -f *.log || true
        rm -f *.png || true
        echo "โ ุชู ุชูุธูู ุงููููุงุช ุงููุคูุชุฉ"

    - name: ๐ ุชูุฑูุฑ ููุงุฆู ุดุงูู
      if: always()
      run: |
        echo "๐ ุงูุชูุฑูุฑ ุงูููุงุฆู ุงูุดุงูู ููุชุดุบูู V2"
        echo "==================================="
        echo "๐ ุญุงูุฉ ุฌููุน ุงูููุงู:"
        echo "  ๐ ูุญุต ุงููุธุงู: ${{ needs.system-check.result }}"
        echo "  ๐ ุงูุฃุชูุชุฉ: ${{ needs.reddit-automation.result }}"
        echo "  ๐ ุงููุฑุงูุจุฉ: ${{ needs.monitoring-report.result }}"
        echo "  ๐งน ุงูุชูุธูู: ${{ job.status }}"
        echo ""
        echo "๐ ุงูุฅุญุตุงุฆูุงุช:"
        echo "  ๐ ุงูุชุดุบูู: ${{ github.run_number }}"
        echo "  ๐ ุงููุญุงููุฉ: ${{ github.run_attempt }}"
        echo "  โฐ ุงููุฏุฉ: ุชู ุงูุชูููุฐ"
        echo ""
        if [[ "${{ needs.system-check.result }}" == "success" ]] && \
           [[ "${{ needs.reddit-automation.result }}" == "success" ]]; then
          echo "๐ ุฌููุน ุงูููุงู ุงูุชููุช ุจูุฌุงุญ!"
          echo "โจ ุงููุธุงู ูุนูู ุจุดูู ูุซุงูู"
        else
          echo "โ๏ธ ุจุนุถ ุงูููุงู ูุงุฌูุช ูุดุงูู - ุฑุงุฌุน ุงูุณุฌูุงุช"
          echo "๐ง ููุตู ุจูุฑุงุฌุนุฉ ุชูุงุฑูุฑ ุงูุฃุฎุทุงุก"
        fi
        echo "==================================="

  # ๐ ุงูุชุนุงูู ุงูุชููุงุฆู (ูุธููุฉ ุงุญุชูุงุทูุฉ)
  auto-recovery:
    name: ๐ ุงูุชุนุงูู ุงูุชููุงุฆู
    runs-on: ubuntu-latest
    needs: [system-check, reddit-automation]
    if: failure() && needs.system-check.result == 'success' && needs.reddit-automation.result == 'failure'
    
    steps:
    - name: ๐ฅ ุงูุญุตูู ุนูู ุงูููุฏ
      uses: actions/checkout@v4

    - name: ๐๏ธ ุฅุนุฏุงุฏ Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ๐ฆ ุชุซุจูุช ุงูุงุนุชูุงุฏูุงุช
      run: npm ci

    - name: ๐ ุชุดุบูู ุงูุชุนุงูู ุงูุชููุงุฆู
      run: |
        echo "๐ ุชุดุบูู ุงูุชุนุงูู ุงูุชููุงุฆู ุงูุงุญุชูุงุทู..."
        if node src/recovery/recovery-manager.js --mode=emergency --auto; then
          echo "โ ุงูุชุนุงูู ุงูุงุญุชูุงุทู ูุงุฌุญ"
        else
          echo "โ ูุดู ุงูุชุนุงูู ุงูุงุญุชูุงุทู"
        fi

    - name: ๐ข ุฅุดุนุงุฑ ุงูุชุนุงูู
      if: always()
      uses: actions/github-script@v6
      run: |
        github.rest.issues.create({
          owner: context.repo.owner,
          repo: context.repo.repo,
          title: `๐ ุชุนุงูู ุชููุงุฆู ุชู ุชุดุบููู - ุงูุชุดุบูู #${context.runNumber}`,
          body: `
          ## ๐ ุชูุฑูุฑ ุงูุชุนุงูู ุงูุชููุงุฆู

          **ุงูุชูุงุตูู:**
          - ๐ ุงูููุช: ${new Date().toLocaleString()}
          - ๐ข ุฑูู ุงูุชุดุบูู: ${context.runNumber}
          - ๐ ุงูุณุจุจ: ูุดู ุงูุชุดุบูู ุงูุฑุฆูุณู

          **ุงูุญุงูุฉ:**
          - ุชู ุชุดุบูู ุฅุฌุฑุงุกุงุช ุงูุชุนุงูู ุชููุงุฆูุงู
          - ุงููุธุงู ูุญุงูู ุงุณุชุนุงุฏุฉ ุงูุชุดุบูู

          *ุชู ุฅูุดุงุก ูุฐุง ุงูุฅุดุนุงุฑ ุชููุงุฆูุงู ุจูุงุณุทุฉ ูุธุงู ุงูุชุนุงูู V2*
          `
        });
